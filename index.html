<!DOCTYPE html>
<html>
<head>
    <title>Singapore Elderly Population Analysis</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        .container { display: flex; }
        .map-container, .chart-container { padding: 20px; }
        .tooltip { 
            position: absolute; 
            padding: 8px; 
            background: white; 
            border: 1px solid #ddd; 
            pointer-events: none;
            font-family: Arial;
        }
        .legend { font-size: 12px; }
    </style>
</head>
<body>
    <div class="container">
        <div id="map-container" class="map-container"></div>
        <div id="chart-container" class="chart-container"></div>
    </div>

<script>
// 初始化配置
const width = 800, height = 600;
const margin = { top: 40, right: 20, bottom: 30, left: 50 };

// 加载数据
Promise.all([
    d3.csv("https://raw.githubusercontent.com/carionb/0322/main/elderly.csv", d3.autoType),
    d3.csv("https://raw.githubusercontent.com/carionb/0322/main/KeyIndicatorsOnTheElderlyAnnual.csv", d3.autoType),
    d3.json("https://raw.githubusercontent.com/carionb/0322/main/sgmap.json") 
]).then(([elderlyData, indicatorData, geoData]) => {
    console.log('数据加载完成', {elderlyData, indicatorData, geoData});

    // 数据预处理
    const parseYear = d3.timeParse("%Y");
    const indicators = indicatorData.columns.slice(1);
    
    // 创建地图投影
    const projection = d3.geoMercator().fitSize([width, height], geoData);
    const path = d3.geoPath().projection(projection);

    // 创建SVG容器
    const svgMap = d3.select("#map-container")
        .append("svg")
        .attr("width", width)
        .attr("height", height);

    // 绘制地图边界
    svgMap.selectAll("path")
        .data(geoData.features)
        .enter().append("path")
        .attr("d", path)
        .attr("fill", "#f0f0f0")
        .attr("stroke", "#999");

    // 创建地区坐标映射
    const townCoordinates = new Map();
    geoData.features.forEach(feature => {
        const townName = feature.properties.PLN_AREA_N; // 根据实际GeoJSON字段调整
        const centroid = d3.geoCentroid(feature);
        townCoordinates.set(townName.toUpperCase(), centroid);
    });

    // 创建颜色比例尺
    const maxRatio = d3.max(elderlyData, d => d.Elderly/d.Total);
    const colorScale = d3.scaleSequential(d3.interpolateReds)
        .domain([0, maxRatio]);

    // 添加数据点（使用2018年数据）
    svgMap.selectAll("circle")
        .data(elderlyData.filter(d => d.SHS_year === 2018))
        .enter().append("circle")
        .attr("cx", d => {
            const coords = townCoordinates.get(d['Town/estate'].toUpperCase());
            return coords ? projection(coords)[0] : -100;
        })
        .attr("cy", d => {
            const coords = townCoordinates.get(d['Town/estate'].toUpperCase());
            return coords ? projection(coords)[1] : -100;
        })
        .attr("r", 8)
        .attr("fill", d => colorScale(d.Elderly/d.Total))
        .attr("opacity", 0.7)
        .on("mouseover", showTooltip)
        .on("mouseout", hideTooltip);

    // 创建折线图
    const svgChart = d3.select("#chart-container")
        .append("svg")
        .attr("width", width)
        .attr("height", height);

    // 处理指标数据
    const validSeries = indicators.filter(indicator => 
        !isNaN(indicatorData[0][indicator])
    );
    
    const series = validSeries.map(indicator => ({
        name: indicator,
        values: indicatorData.map(d => ({
            year: parseYear(d.DataSeries),
            value: +d[indicator]
        })).filter(d => !isNaN(d.value))
    }));

    // 创建比例尺
    const xScale = d3.scaleTime()
        .domain(d3.extent(indicatorData, d => parseYear(d.DataSeries)))
        .range([margin.left, width - margin.right]);

    const yScale = d3.scaleLinear()
        .domain([0, d3.max(series, d => d3.max(d.values, v => v.value))])
        .range([height - margin.bottom, margin.top]);

    // 创建折线生成器
    const line = d3.line()
        .x(d => xScale(d.year))
        .y(d => yScale(d.value));

    // 绘制折线
    svgChart.selectAll(".line")
        .data(series)
        .enter().append("path")
        .attr("class", "line")
        .attr("d", d => line(d.values))
        .attr("fill", "none")
        .attr("stroke", (d,i) => d3.schemeCategory10[i % 10])
        .attr("stroke-width", 2);

    // 添加坐标轴
    svgChart.append("g")
        .attr("transform", `translate(0,${height - margin.bottom})`)
        .call(d3.axisBottom(xScale).tickFormat(d3.timeFormat("%Y")));

    svgChart.append("g")
        .attr("transform", `translate(${margin.left},0)`)
        .call(d3.axisLeft(yScale));

    // 工具提示
    const tooltip = d3.select("body").append("div").attr("class", "tooltip");

    function showTooltip(event, d) {
        tooltip
            .html(`
                <strong>${d['Town/estate']}</strong><br>
                Older Adult: ${d.Elderly.toLocaleString()}<br>
                Total: ${d.Total.toLocaleString()}<br>
                Rate: ${(d.Elderly/d.Total*100).toFixed(1)}%
            `)
            .style("left", event.pageX + 15 + "px")
            .style("top", event.pageY + 15 + "px")
            .style("opacity", 1);
    }

    function hideTooltip() {
        tooltip.style("opacity", 0);
    }

}).catch(error => {
    console.error("数据加载错误:", error);
    alert("数据加载失败，请检查控制台日志");
});
</script>
</body>
</html>
