<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Elderly & HDB Prices Map</title>
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <style>
    body { font-family: Arial; margin: 20px; }
    .tooltip {
      position: absolute;
      background: white;
      padding: 8px;
      border: 1px solid #999;
      pointer-events: none;
      font-size: 12px;
    }
    .controls { margin-bottom: 20px; }
    svg { border: 1px solid #ccc; }
  </style>
</head>
<body>

<div class="controls">
  <label>Year:</label>
  <select id="year-select">
    <option>2003</option>
    <option>2008</option>
    <option>2013</option>
    <option selected>2018</option>
  </select>

  <label style="margin-left: 20px;">Room Type:</label>
  <select id="room-select">
    <option>2-room</option>
    <option>3-room</option>
    <option>4-room</option>
    <option>5-room</option>
    <option>Executive</option>
  </select>

  <label style="margin-left: 20px;">
    <input type="checkbox" id="toggle-price" /> Show HDB Prices
  </label>
</div>

<svg id="map" width="1000" height="600"></svg>
<div id="tooltip" class="tooltip" style="opacity:0"></div>

<script>
const svg = d3.select("#map");
const g = svg.append("g"); // group for zoom
const projection = d3.geoMercator().center([103.8, 1.35]).scale(45000).translate([500, 300]);
const path = d3.geoPath().projection(projection);
const tooltip = d3.select("#tooltip");

function normalizeName(name) {
  return name.trim().toUpperCase().replace(/[^A-Z]/g, '');
}
function extractPLNAreaName(desc) {
  const match = desc?.match(/<th>PLN_AREA_N<\/th>\\s*<td>([^<]+)<\\/td>/i);
  return match ? match[1].trim() : null;
}

Promise.all([
  d3.csv("https://raw.githubusercontent.com/carionb/0322/main/elderly.csv", d3.autoType),
  d3.csv("https://raw.githubusercontent.com/carionb/0322/main/PriceRangeofHDBFlatsOffered.csv", d3.autoType),
  d3.json("https://raw.githubusercontent.com/carionb/0322/main/MasterPlan2019PlanningAreaBoundaryNoSea.geojson")
]).then(([elderlyData, priceData, geoData]) => {

  priceData.forEach(d => {
    d.avg_price = (+d.min_selling_price + +d.max_selling_price) / 2;
    d.norm_town = normalizeName(d["Town/estate"]);
  });

  const areaMap = new Map();
  geoData.features.forEach(f => {
    const name = extractPLNAreaName(f.properties.Description);
    if (name) {
      areaMap.set(normalizeName(name), {
        name: name,
        centroid: d3.geoCentroid(f)
      });
    }
  });

  const zoom = d3.zoom()
    .scaleExtent([1, 8])
    .on("zoom", (event) => {
      g.attr("transform", event.transform);
    });
  svg.call(zoom);

  function drawMap(year, roomType, showPrice) {
    g.selectAll("*").remove();

    const elderlyMap = new Map(
      elderlyData
        .filter(d => d.SHS_year === +year)
        .map(d => [normalizeName(d["Town/estate"]), d])
    );

    g.selectAll("path")
      .data(geoData.features)
      .join("path")
      .attr("d", path)
      .attr("stroke", "#aaa")
      .attr("fill", d => {
        const town = extractPLNAreaName(d.properties.Description);
        const data = elderlyMap.get(normalizeName(town));
        return data ? d3.interpolateReds(data.Elderly / data.Total) : "#eee";
      });

    if (showPrice) {
      const priceFiltered = priceData.filter(d =>
        d.financial_year === +year && d.room_type.toLowerCase() === roomType.toLowerCase()
      );
      const maxPrice = d3.max(priceFiltered, d => d.avg_price);
      const rScale = d3.scaleSqrt().domain([0, maxPrice]).range([0, 20]);

      g.selectAll("circle")
        .data(priceFiltered)
        .join("circle")
        .attr("cx", d => {
          const loc = areaMap.get(d.norm_town);
          return loc ? projection(loc.centroid)[0] : -999;
        })
        .attr("cy", d => {
          const loc = areaMap.get(d.norm_town);
          return loc ? projection(loc.centroid)[1] : -999;
        })
        .attr("r", d => rScale(d.avg_price))
        .attr("fill", d => d3.interpolateBlues(d.avg_price / maxPrice))
        .attr("opacity", 0.8)
        .on("mouseover", (event, d) => {
          const ed = elderlyMap.get(d.norm_town);
          tooltip
            .html(`<strong>${d["Town/estate"]}</strong><br>
                   ${roomType} Avg Price: $${Math.round(d.avg_price)}<br>
                   Elderly: ${ed?.Elderly ?? "?"}<br>
                   Total: ${ed?.Total ?? "?"}`)
            .style("left", event.pageX + 10 + "px")
            .style("top", event.pageY + 10 + "px")
            .style("opacity", 1);
        })
        .on("mouseout", () => tooltip.style("opacity", 0));
    }
  }

  function update() {
    const year = document.getElementById("year-select").value;
    const room = document.getElementById("room-select").value;
    const show = document.getElementById("toggle-price").checked;
    drawMap(year, room, show);
  }

  document.getElementById("year-select").addEventListener("change", update);
  document.getElementById("room-select").addEventListener("change", update);
  document.getElementById("toggle-price").addEventListener("change", update);

  update();
});
</script>

</body>
</html>
