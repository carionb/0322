<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Singapore Elderly Population with HDB Prices Overlay</title>
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <style>
    body { font-family: Arial; margin: 20px; }
    #map { width: 1000px; height: 600px; border: 1px solid #ccc; }
    .tooltip {
      position: absolute;
      background: white;
      padding: 8px;
      border: 1px solid #999;
      pointer-events: none;
      font-size: 12px;
    }
    .controls { margin-bottom: 20px; }
  </style>
</head>
<body>

<div class="controls">
  <label>Year:</label>
  <select id="year-select">
    <option>2003</option>
    <option>2008</option>
    <option>2013</option>
    <option selected>2018</option>
  </select>

  <label style="margin-left:20px">
    <input type="checkbox" id="toggle-price" /> Show HDB Prices
  </label>
</div>

<svg id="map"></svg>
<div id="tooltip" class="tooltip" style="opacity:0"></div>

<script>
const width = 1000, height = 600;
const svg = d3.select("#map").attr("width", width).attr("height", height);
const projection = d3.geoMercator().center([103.8, 1.35]).scale(45000).translate([width / 2, height / 2]);
const path = d3.geoPath().projection(projection);
const tooltip = d3.select("#tooltip");

function normalizeName(name) {
  return name.trim().toUpperCase().replace(/[^A-Z]/g, '');
}

function extractPLNAreaName(desc) {
  const match = desc?.match(/<th>PLN_AREA_N<\/th>\s*<td>([^<]+)<\/td>/i);
  return match ? match[1].trim() : null;
}

Promise.all([
  d3.csv("https://raw.githubusercontent.com/carionb/0322/main/elderly.csv", d3.autoType),
  d3.csv("https://raw.githubusercontent.com/carionb/0322/main/PriceRangeofHDBFlatsOffered.csv", d3.autoType),
  d3.json("https://raw.githubusercontent.com/carionb/0322/main/MasterPlan2019PlanningAreaBoundaryNoSea.geojson")
]).then(([elderlyData, priceData, geoData]) => {

  priceData.forEach(d => {
    d.avg_price = (+d.min_selling_price + +d.max_selling_price) / 2;
  });

  const priceRollup = d3.rollup(
    priceData,
    v => d3.mean(v, d => d.avg_price),
    d => String(d.financial_year),
    d => normalizeName(d["Town/estate"])
  );

  const areaMap = new Map();
  geoData.features.forEach(f => {
    const name = extractPLNAreaName(f.properties.Description);
    if (name) {
      areaMap.set(normalizeName(name), {
        name: name,
        centroid: d3.geoCentroid(f)
      });
    }
  });

  function drawRegions(year) {
    const filteredElderly = elderlyData.filter(d => d.SHS_year === +year);
    const elderlyMap = new Map(filteredElderly.map(d => [normalizeName(d["Town/estate"]), d]));

    svg.selectAll("path")
      .data(geoData.features)
      .join("path")
      .attr("d", path)
      .attr("stroke", "#999")
      .attr("fill", d => {
        const town = extractPLNAreaName(d.properties.Description);
        const key = normalizeName(town);
        const data = elderlyMap.get(key);
        return data ? d3.interpolateReds(data.Elderly / data.Total) : "#eee";
      });
  }

  function drawPriceCircles(year) {
    svg.selectAll("circle").remove();

    const townPrices = priceRollup.get(String(year)) || new Map();
    const maxPrice = d3.max(Array.from(townPrices.values()));

    svg.selectAll("circle")
      .data(Array.from(townPrices.entries()))
      .join("circle")
      .attr("cx", ([town, price]) => {
        const loc = areaMap.get(town);
        return loc ? projection(loc.centroid)[0] : -999;
      })
      .attr("cy", ([town, price]) => {
        const loc = areaMap.get(town);
        return loc ? projection(loc.centroid)[1] : -999;
      })
      .attr("r", ([, price]) => Math.sqrt(price) / 500)
      .attr("fill", ([, price]) => d3.interpolateBlues(price / maxPrice))
      .attr("opacity", 0.8)
      .on("mouseover", (event, [town, price]) => {
        const elderlyEntry = elderlyData.find(d => normalizeName(d["Town/estate"]) === town && d.SHS_year === +year);
        tooltip
          .html(`<strong>${town}</strong><br>
                 Elderly: ${elderlyEntry?.Elderly ?? "?"}<br>
                 Total: ${elderlyEntry?.Total ?? "?"}<br>
                 Price: $${Math.round(price)}`)
          .style("left", event.pageX + 10 + "px")
          .style("top", event.pageY + 10 + "px")
          .style("opacity", 1);
      })
      .on("mouseout", () => tooltip.style("opacity", 0));
  }

  function update() {
    const year = document.getElementById("year-select").value;
    const showPrice = document.getElementById("toggle-price").checked;
    drawRegions(year);
    if (showPrice) drawPriceCircles(year);
    else svg.selectAll("circle").remove();
  }

  document.getElementById("year-select").addEventListener("change", update);
  document.getElementById("toggle-price").addEventListener("change", update);

  update(); // initial draw
});
</script>

</body>
</html>
