<!DOCTYPE html>
<html>
<head>
    <title>Singapore Elderly Visualization</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        /* 保持原有样式不变 */
        body { margin: 0; padding: 20px }
        .map { border: 1px solid #ddd }
        .tooltip { /* 原有样式 */ }
    </style>
</head>
<body>
    <div id="vis-container">
        <select id="yearSelect">
            <option value="2003">2003</option>
            <option value="2008">2008</option>
            <option value="2013">2013</option>
            <option value="2018">2018</option>
        </select>
    </div>

<script>
// GitHub配置参数
const REPO_OWNER = 'carionb';
const REPO_NAME = '0322';
const BRANCH = 'main';

// 数据路径生成函数
const ghDataPath = file => 
    `https://raw.githubusercontent.com/${REPO_OWNER}/${REPO_NAME}/${BRANCH}/data/${file}`;

// 可视化参数
const width = 960;
const height = 600;

// 初始化可视化
const svg = d3.select("#vis-container")
    .append("svg")
    .attr("width", width)
    .attr("height", height)
    .classed("map", true);

// 加载数据
Promise.all([
    d3.json(ghDataPath('sgmap.json')),
    d3.csv(ghDataPath('elderly.csv')),
    d3.csv(ghDataPath('KeyIndicatorsOnTheElderlyAnnual.csv'))
]).then(([geoData, elderlyData, indicators]) => {
    
    // 数据预处理
    const elderlyMap = d3.group(elderlyData, d => d["SHS_year"]);
    
    // 创建投影
    const projection = d3.geoMercator()
        .fitSize([width, height], geoData);
    
    // 创建路径生成器
    const path = d3.geoPath().projection(projection);
    
    // 初始渲染
    updateMap('2003');
    
    // 年份选择事件
    d3.select("#yearSelect").on("change", function() {
        updateMap(this.value);
    });
    
    function updateMap(year) {
        // 数据匹配逻辑
        const yearData = elderlyMap.get(year);
        const dataLookup = new Map(yearData.map(d => [
            d["Town/estate"].toUpperCase().trim(), 
            d
        ]));
        
        // 绘制地图
        svg.selectAll("path")
            .data(geoData.features)
            .join("path")
            .attr("d", path)
            .attr("fill", d => {
                const areaName = d.properties["Subzone Name"].toUpperCase().trim();
                const match = dataLookup.get(areaName);
                return match ? colorScale(match.Elderly / match.Total) : '#eee';
            })
            .on("mouseover", showTooltip)
            .on("mouseout", hideTooltip);
    }
    
    // 工具提示函数
    function showTooltip(event, d) {
        /* 保持原有工具提示逻辑 */
    }
    
    function hideTooltip() {
        /* 保持原有工具提示逻辑 */
    }
}).catch(error => {
    console.error("数据加载错误:", error);
    d3.select("#vis-container")
        .append("div")
        .style("color", "red")
        .html(`数据加载失败: ${error.message}`);
});
</script>
</body>
</html>
