<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Interactive Visualization: COE Premiums & Vehicle Population</title>
  <script src="https://d3js.org/d3.v6.min.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
      background: #f4f4f4;
    }
    .container {
      background: #fff;
      padding: 20px;
      margin-bottom: 20px;
      border-radius: 4px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    h2 { margin-top: 0; }
    .axis path,
    .axis line {
      fill: none;
      stroke: #000;
    }
    .grid line {
      stroke: #ccc;
      stroke-dasharray: 3 3;
    }
    .line {
      fill: none;
      stroke-width: 2px;
    }
    .tooltip {
      position: absolute;
      background: lightsteelblue;
      padding: 5px;
      border: 1px solid #000;
      pointer-events: none;
      opacity: 0;
      transition: opacity 0.3s ease;
    }
    .checkbox-container {
      margin-bottom: 10px;
    }
    /* 为各部分添加边框 */
    #description, .checkbox-container, #chart-container {
      border: 1px solid #ddd;
      border-radius: 4px;
    }
    .legend {
      font-size: 12px;
    }
  </style>
</head>
<body>
  <!-- 描述部分 -->
  <div id="description" class="container">
    <h2>Hypothesis and Data Description</h2>
    <p>
      I hypothesize that there is a positive correlation between COE premiums and the overall vehicle population in Singapore. As the vehicle population increases, the demand for vehicles intensifies, which may drive up COE premiums. Conversely, periods with a declining vehicle population might correspond with lower premiums.
    </p>
    <p>
      The analysis uses two datasets:
      <strong>COE Bidding Results / Prices</strong> (from Jan-10 to Mar-25, premium values)
      and <strong>Annual Motor Vehicle Population by Vehicle Type</strong> (from 2005 to 2025, vehicle numbers).
      The chart displays a dual-axis time series with the left y-axis representing COE Premiums and the right y-axis representing the aggregated total vehicles per year.
    </p>
  </div>
  
  <!-- 过滤选项 -->
  <div class="container checkbox-container">
    <label><input type="checkbox" id="toggleCoe" checked> Show COE Premiums</label>
    <label style="margin-left: 20px;"><input type="checkbox" id="toggleVehicle" checked> Show Total Vehicle Count</label>
  </div>
  
  <!-- 图表部分 -->
  <div id="chart-container" class="container">
    <svg id="chart" viewBox="0 0 900 500" preserveAspectRatio="xMidYMid meet"></svg>
    <div class="tooltip" id="tooltip"></div>
  </div>
  
  <script>
    // 定义 SVG 尺寸与边距
    const svgWidth = 900, svgHeight = 500;
    const margin = { top: 20, right: 60, bottom: 40, left: 60 };
    const chartWidth = svgWidth - margin.left - margin.right;
    const chartHeight = svgHeight - margin.top - margin.bottom;
    
    // 创建 SVG 元素及图表分组
    const svg = d3.select("#chart");
    const chartGroup = svg.append("g")
                          .attr("transform", `translate(${margin.left},${margin.top})`);
    
    // 定义日期解析函数
    const parseCoeDate = d3.timeParse("%Y-%m");
    const parseVehicleYear = d3.timeParse("%Y");
    
    // 清理 CSV 数据中的多余空白
    const cleanRow = row => {
      const newRow = {};
      for (const key in row) {
        newRow[key.trim()] = typeof row[key] === "string" ? row[key].trim() : row[key];
      }
      return newRow;
    };
    
    // CSV 数据源 URL
    const coeURL = "https://raw.githubusercontent.com/carionb/0322/main/COEBiddingResultsPrices.csv";
    const vehicleURL = "https://raw.githubusercontent.com/carionb/0322/main/AnnualMotorVehiclePopulationbyVehicleType.csv";
    
    // 加载 CSV 数据
    Promise.all([
      d3.csv(coeURL, cleanRow),
      d3.csv(vehicleURL, cleanRow)
    ]).then(([coeData, vehicleData]) => {
      // 处理 COE 数据：解析日期并转换 premium 为数字
      coeData.forEach(d => {
        d.date = d.month ? parseCoeDate(d.month) : null;
        if (!d.date) console.error("日期解析失败：", d.month);
        d.premium = d.premium ? +d.premium.replace(/,/g, "") : NaN;
      });
      
      // 处理车辆数据：解析年份并转换 number 为数字
      vehicleData.forEach(d => {
        d.yearParsed = d.year ? parseVehicleYear(d.year) : null;
        d.number = d.number ? +d.number.replace(/,/g, "") : 0;
      });
      
      // 按年份聚合车辆数据（忽略 category/type 维度）
      const aggregatedVehicleData = Array.from(
        d3.rollup(vehicleData, v => d3.sum(v, d => d.number), d => d.year),
        ([year, total]) => ({ year: parseVehicleYear(year), total })
      ).sort((a, b) => a.year - b.year);
      
      // 定义 x 轴范围：结合两个数据集的最小、最大日期
      const xMin = d3.min([d3.min(coeData, d => d.date), d3.min(aggregatedVehicleData, d => d.year)]);
      const xMax = d3.max([d3.max(coeData, d => d.date), d3.max(aggregatedVehicleData, d => d.year)]);
      const xScale = d3.scaleTime().domain([xMin, xMax]).range([0, chartWidth]);
      
      // 定义左右 y 轴比例尺
      const yLeft = d3.scaleLinear()
                      .domain([0, d3.max(coeData, d => d.premium)]).nice()
                      .range([chartHeight, 0]);
      const yRight = d3.scaleLinear()
                       .domain([0, d3.max(aggregatedVehicleData, d => d.total)]).nice()
                       .range([chartHeight, 0]);
      
      // 添加 x 轴
      const xAxis = d3.axisBottom(xScale);
      chartGroup.append("g")
                .attr("class", "x axis")
                .attr("transform", `translate(0, ${chartHeight})`)
                .call(xAxis);
      
      // 添加左侧 y 轴（COE Premium）
      const yAxisLeft = d3.axisLeft(yLeft).tickFormat(d => `$${d}`);
      chartGroup.append("g")
                .attr("class", "y axis left")
                .call(yAxisLeft)
                .append("text")
                .attr("transform", "rotate(-90)")
                .attr("y", -50)
                .attr("dy", "0.71em")
                .attr("text-anchor", "end")
                .attr("fill", "steelblue")
                .text("COE Premium");
      
      // 添加右侧 y 轴（Total Vehicles）
      const yAxisRight = d3.axisRight(yRight);
      chartGroup.append("g")
                .attr("class", "y axis right")
                .attr("transform", `translate(${chartWidth}, 0)`)
                .call(yAxisRight)
                .append("text")
                .attr("transform", "rotate(-90)")
                .attr("y", 40)
                .attr("dy", "0.71em")
                .attr("text-anchor", "end")
                .attr("fill", "orange")
                .text("Total Vehicles");
      
      // 添加网格线（x、y 轴）
      const xGrid = d3.axisBottom(xScale).ticks(5);
      chartGroup.append("g")
                .attr("class", "grid x-grid")
                .attr("transform", `translate(0, ${chartHeight})`)
                .call(xGrid.tickSize(-chartHeight).tickFormat(""));
      
      const yGrid = d3.axisLeft(yLeft).ticks(5);
      chartGroup.append("g")
                .attr("class", "grid y-grid")
                .call(yGrid.tickSize(-chartWidth).tickFormat(""));
      
      // 定义折线生成器
      const lineCOE = d3.line()
                        .x(d => xScale(d.date))
                        .y(d => yLeft(d.premium));
      const lineVehicle = d3.line()
                            .x(d => xScale(d.year))
                            .y(d => yRight(d.total));
      
      // 绘制 COE 折线
      chartGroup.append("path")
                .datum(coeData)
                .attr("class", "line coe-line")
                .attr("stroke", "steelblue")
                .attr("d", lineCOE);
      
      // 绘制车辆总数折线
      chartGroup.append("path")
                .datum(aggregatedVehicleData)
                .attr("class", "line vehicle-line")
                .attr("stroke", "orange")
                .attr("d", lineVehicle);
      
      // tooltip 元素
      const tooltip = d3.select("#tooltip");
      
      // tooltip 处理函数
      const handleMouseOver = (event, d, label, value) => {
        tooltip.transition().duration(200).style("opacity", 0.9);
        tooltip.html(`${label}: ${value}`)
               .style("left", `${event.pageX + 10}px`)
               .style("top", `${event.pageY - 28}px`);
      };
      
      // 添加 COE 数据点与 tooltip
      chartGroup.selectAll(".dot-coe")
                .data(coeData)
                .enter()
                .append("circle")
                .attr("class", "dot-coe")
                .attr("cx", d => xScale(d.date))
                .attr("cy", d => yLeft(d.premium))
                .attr("r", 3)
                .attr("fill", "steelblue")
                .on("mouseover", (event, d) => {
                  handleMouseOver(
                    event, 
                    d, 
                    "Month", 
                    `${d3.timeFormat("%b %Y")(d.date)}<br/>Premium: $${d.premium}`
                  );
                })
                .on("mouseout", () => {
                  tooltip.transition().duration(500).style("opacity", 0);
                });
      
      // 添加车辆数据点与 tooltip
      chartGroup.selectAll(".dot-vehicle")
                .data(aggregatedVehicleData)
                .enter()
                .append("circle")
                .attr("class", "dot-vehicle")
                .attr("cx", d => xScale(d.year))
                .attr("cy", d => yRight(d.total))
                .attr("r", 3)
                .attr("fill", "orange")
                .on("mouseover", (event, d) => {
                  handleMouseOver(
                    event, 
                    d, 
                    "Year", 
                    `${d3.timeFormat("%Y")(d.year)}<br/>Total: ${d.total}`
                  );
                })
                .on("mouseout", () => {
                  tooltip.transition().duration(500).style("opacity", 0);
                });
      
      // 复选框交互：切换系列显示
      d3.select("#toggleCoe").on("change", function() {
        const visibility = this.checked ? "visible" : "hidden";
        chartGroup.selectAll(".coe-line, .dot-coe").style("visibility", visibility);
      });
      
      d3.select("#toggleVehicle").on("change", function() {
        const visibility = this.checked ? "visible" : "hidden";
        chartGroup.selectAll(".vehicle-line, .dot-vehicle").style("visibility", visibility);
      });
      
      // 添加图例，帮助区分折线
      const legend = svg.append("g")
                        .attr("class", "legend")
                        .attr("transform", `translate(${margin.left}, ${margin.top})`);
      
      legend.append("circle")
            .attr("cx", chartWidth - 120)
            .attr("cy", 10)
            .attr("r", 6)
            .style("fill", "steelblue");
      
      legend.append("text")
            .attr("x", chartWidth - 105)
            .attr("y", 15)
            .text("COE Premiums")
            .style("font-size", "12px")
            .attr("alignment-baseline", "middle");
      
      legend.append("circle")
            .attr("cx", chartWidth - 120)
            .attr("cy", 30)
            .attr("r", 6)
            .style("fill", "orange");
      
      legend.append("text")
            .attr("x", chartWidth - 105)
            .attr("y", 35)
            .text("Total Vehicles")
            .style("font-size", "12px")
            .attr("alignment-baseline", "middle");
      
    }).catch(error => {
      console.error("Error loading CSV data:", error);
    });
  </script>
</body>
</html>
