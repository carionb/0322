<!DOCTYPE html>
<html>
<head>
    <title>Singapore Elderly Population and HDB Prices</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        .container { display: grid; grid-template-rows: auto auto; gap: 20px; padding: 20px; }
        #map-container { height: 700px; border: 1px solid #ddd; }
        #chart-container { height: 400px; border: 1px solid #ddd; }
        .tooltip {
            position: absolute;
            padding: 10px;
            background: white;
            border: 1px solid #ccc;
            pointer-events: none;
            font-family: Arial;
        }
        .dropdown { margin: 20px; }
    </style>
</head>
<body>
<div class="container">
    <div id="map-container"></div>
    <div id="chart-container"></div>
</div>
<div class="dropdown">
    <label for="year-select">Select Year:</label>
    <select id="year-select">
        <option value="2003">2003</option>
        <option value="2008">2008</option>
        <option value="2013">2013</option>
        <option value="2018" selected>2018</option>
    </select>
    <br><br>
    <label for="view-mode">Display Mode:</label>
    <select id="view-mode">
        <option value="elderly">Elderly Proportion</option>
        <option value="price">Average HDB Price</option>
    </select>
    <br><br>
    <label for="indicator-select">Select Indicator:</label>
    <select id="indicator-select">
        <option value="Proportion Of Elderly Residents (65 Years & Over) Among Resident Population">Proportion of Elderly Residents</option>
        <option value="Sex Ratio Of Elderly Residents (65 Years & Over)">Sex Ratio of Elderly Residents</option>
        <option value="Proportion Of Elderly Residents (65 Years & Over) In Labour Force">Elderly Labour Force Participation Rate</option>
    </select>
</div>

<script>
const mapWidth = 1000, mapHeight = 600;
const chartWidth = 1000, chartHeight = 400;
const margin = { top: 30, right: 30, bottom: 50, left: 60 };

Promise.all([
    d3.csv("https://raw.githubusercontent.com/carionb/0322/main/elderly.csv", d3.autoType),
    d3.csv("https://raw.githubusercontent.com/carionb/0322/main/KeyIndicatorsOnTheElderlyAnnual.csv", d3.autoType),
    d3.csv("https://raw.githubusercontent.com/carionb/0322/main/PriceRangeofHDBFlatsOffered.csv", d3.autoType),
    d3.json("https://raw.githubusercontent.com/carionb/0322/main/MasterPlan2019PlanningAreaBoundaryNoSea.geojson")
]).then(([elderlyData, indicatorData, priceData, geoData]) => {

    const projection = d3.geoMercator().center([103.8, 1.35]).scale(45000).translate([mapWidth / 2, mapHeight / 2]);
    const path = d3.geoPath().projection(projection);

    const svgMap = d3.select("#map-container").append("svg").attr("width", mapWidth).attr("height", mapHeight);
    svgMap.selectAll("path").data(geoData.features).enter().append("path")
        .attr("d", path).attr("fill", "#f0f0f0").attr("stroke", "#666");

    const normalizeName = name => name.trim().toUpperCase().replace(/[^A-Z]/g, "");

    // ========== 地理数据处理 ==========
    function extractPLNAreaName(description) {
      if (!description) return null;
      const regex = /<th>PLN_AREA_N<\/th>\s*<td>([^<]+)<\/td>/i;
      const match = description.match(regex);
      return match ? match[1].trim() : null;
    }

    const areaMap = new Map();
    geoData.features.forEach(f => {
      const name = extractPLNAreaName(f.properties.Description);
      if (name) {
        const normalized = normalizeName(name);
        const centroid = d3.geoCentroid(f);
        areaMap.set(normalized, centroid);
        console.log(`映射区域: ${name} => ${normalized}`, centroid);
      }
    });

    // ========== 价格数据处理 ==========
    priceData.forEach(d => {
      d.min_selling_price = +d.min_selling_price;
      d.max_selling_price = +d.max_selling_price;
      d.avg_price = (d.min_selling_price + d.max_selling_price) / 2;
    });

    const priceRollup = d3.rollup(
      priceData,
      v => d3.mean(v, d => d.avg_price),
      d => String(d.financial_year),
      d => normalizeName(d["Town/estate"])
    );
    console.log("价格聚合结果:", priceRollup);

    function drawCircles(year, mode) {
      const filtered = elderlyData.filter(d => d.SHS_year === +year);
      console.log(`过滤到${filtered.length}条${year}年数据`);

      const validEntries = Array.from(priceRollup.get(String(year))?.entries() || []);
      console.log(`${year}年有效价格数据:`, validEntries);

      const maxPrice = d3.max(validEntries, ([k, v]) => v) || 1;

      const circles = svgMap.selectAll("circle").data(filtered, d => d['Town/estate']);

      circles.join(
        enter => enter.append("circle")
          .attr("cx", d => {
            const key = normalizeName(d['Town/estate']);
            const coords = areaMap.get(key);
            return coords ? projection(coords)[0] : -1000;
          })
          .attr("cy", d => {
            const key = normalizeName(d['Town/estate']);
            const coords = areaMap.get(key);
            return coords ? projection(coords)[1] : -1000;
          })
          .attr("r", d => Math.sqrt(d.Total) / 50)
          .attr("fill", d => {
            const key = normalizeName(d['Town/estate']);
            if (mode === 'price') {
              const price = priceRollup.get(String(year))?.get(key);
              return price ? d3.interpolateBlues(price / maxPrice) : '#ccc';
            } else {
              return d3.interpolateReds(d.Elderly / d.Total);
            }
          })
          .attr("opacity", 0.8)
          .on("mouseover", showMapTooltip)
          .on("mouseout", hideTooltip),
        update => update.transition().duration(500)
          .attr("fill", d => {
            const key = normalizeName(d['Town/estate']);
            if (mode === 'price') {
              const price = priceRollup.get(String(year))?.get(key);
              return price ? d3.interpolateBlues(price / maxPrice) : '#ccc';
            } else {
              return d3.interpolateReds(d.Elderly / d.Total);
            }
          }),
        exit => exit.remove()
      );
    }

    function updateMap() {
        const year = document.getElementById("year-select").value;
        const mode = document.getElementById("view-mode").value;
        drawCircles(year, mode);
    }

    document.getElementById("year-select").addEventListener("change", updateMap);
    document.getElementById("view-mode").addEventListener("change", updateMap);
    updateMap();

    const svgChart = d3.select("#chart-container").append("svg")
        .attr("width", chartWidth).attr("height", chartHeight);

    const xScale = d3.scaleLinear().domain(d3.extent(indicatorData, d => +d.DataSeries))
        .range([margin.left, chartWidth - margin.right]);
    const yScale = d3.scaleLinear().range([chartHeight - margin.bottom, margin.top]);

    const line = d3.line().x(d => xScale(d.year)).y(d => yScale(d.value));

    function updateChart(selectedIndicator) {
        const dataset = indicatorData.map(d => ({
            year: +d.DataSeries,
            value: +d[selectedIndicator]
        })).filter(d => !isNaN(d.value));

        yScale.domain([0, d3.max(dataset, d => d.value)]);

        svgChart.selectAll(".line")
            .data([dataset])
            .join("path")
            .attr("class", "line")
            .attr("d", line)
            .attr("fill", "none")
            .attr("stroke", "steelblue")
            .attr("stroke-width", 2);

        svgChart.selectAll(".x-axis").remove();
        svgChart.selectAll(".y-axis").remove();

        svgChart.append("g")
            .attr("class", "x-axis")
            .attr("transform", `translate(0,${chartHeight - margin.bottom})`)
            .call(d3.axisBottom(xScale).ticks(10).tickFormat(d3.format("d")));

        svgChart.append("g")
            .attr("class", "y-axis")
            .attr("transform", `translate(${margin.left},0)`)
            .call(d3.axisLeft(yScale));
    }

    updateChart(document.getElementById("indicator-select").value);
    d3.select("#indicator-select").on("change", function () {
        updateChart(this.value);
    });

    const tooltip = d3.select("body").append("div").attr("class", "tooltip");

    function showMapTooltip(event, d) {
        const key = normalizeName(d['Town/estate']);
        const year = String(document.getElementById("year-select").value);
        const price = priceRollup.get(year)?.get(key);

        tooltip
            .html(`
                <strong>${d['Town/estate']} (${d.SHS_year})</strong>
                <div>Total Population: ${d.Total.toLocaleString()}</div>
                <div>Elderly Population: ${d.Elderly.toLocaleString()}</div>
                <div>Proportion: ${(d.Elderly / d.Total * 100).toFixed(1)}%</div>
                ${price ? `<div>Avg HDB Price: $${Math.round(price).toLocaleString()}</div>` : ''}
            `)
            .style("left", event.pageX + 15 + "px")
            .style("top", event.pageY + 15 + "px")
            .style("opacity", 1);
    }

    function hideTooltip() {
        tooltip.style("opacity", 0);
    }

}).catch(error => {
    console.error("Data loading error:", error);
    alert("Failed to load data. Check console for details.");
});
</script>
</body>
</html>
