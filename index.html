<!DOCTYPE html>
<html>
<head>
    <title>Singapore Elderly Population Analysis</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        .container { display: flex; }
        .map-container, .chart-container { padding: 20px; }
        .tooltip { position: absolute; padding: 8px; background: white; border: 1px solid #ddd; pointer-events: none; }
        .legend { font-size: 12px; }
    </style>
</head>
<body>
    <div class="container">
        <div id="map-container" class="map-container"></div>
        <div id="chart-container" class="chart-container"></div>
    </div>

<script>
// 初始化配置
const width = 800, height = 600;
const margin = { top: 40, right: 20, bottom: 30, left: 50 };

// 加载数据
Promise.all([
    d3.csv("elderly.csv", d3.autoType),
    d3.csv("KeyIndicatorsOnTheElderlyAnnual.csv", d3.autoType),
    d3.json("https://github.com/carionb/0322/blob/main/sgmap.json") 
]).then(([elderlyData, indicatorData, geoData]) => {

    // 数据预处理
    const parseYear = d3.timeParse("%Y");
    const indicators = indicatorData.columns.slice(1);
    
    // 创建地图
    const projection = d3.geoMercator().fitSize([width, height], geoData);
    const path = d3.geoPath().projection(projection);

    // 创建SVG容器
    const svgMap = d3.select("#map-container")
        .append("svg")
        .attr("width", width)
        .attr("height", height);

    // 绘制地图
    svgMap.selectAll("path")
        .data(geoData.features)
        .enter().append("path")
        .attr("d", path)
        .attr("fill", "#eee")
        .attr("stroke", "#fff");

    // 创建比例尺
    const colorScale = d3.scaleSequential(d3.interpolateReds)
        .domain([0, d3.max(elderlyData, d => d.Elderly/d.Total)]);

    // 添加数据点
    svgMap.selectAll("circle")
        .data(elderlyData.filter(d => d.SHS_year === 2018))
        .enter().append("circle")
        .attr("cx", d => projection([d['Town/estate'] coordinates])[0]) // 需要真实坐标数据
        .attr("cy", d => projection([d['Town/estate'] coordinates])[1])
        .attr("r", 5)
        .attr("fill", d => colorScale(d.Elderly/d.Total))
        .on("mouseover", showTooltip)
        .on("mouseout", hideTooltip);

    // 创建折线图
    const svgChart = d3.select("#chart-container")
        .append("svg")
        .attr("width", width)
        .attr("height", height);

    // 处理指标数据
    const series = indicators.map(indicator => ({
        name: indicator,
        values: indicatorData.map(d => ({
            year: parseYear(d.DataSeries),
            value: +d[indicator]
        }))
    }));

    // 绘制折线
    const xScale = d3.scaleTime()
        .domain(d3.extent(indicatorData, d => parseYear(d.DataSeries)))
        .range([margin.left, width - margin.right]);

    const yScale = d3.scaleLinear()
        .domain([0, d3.max(series, d => d3.max(d.values, v => v.value))])
        .range([height - margin.bottom, margin.top]);

    const line = d3.line()
        .x(d => xScale(d.year))
        .y(d => yScale(d.value));

    svgChart.selectAll("path")
        .data(series)
        .enter().append("path")
        .attr("d", d => line(d.values))
        .attr("fill", "none")
        .attr("stroke", (d,i) => d3.schemeCategory10[i]);

    // 添加坐标轴
    svgChart.append("g")
        .attr("transform", `translate(0,${height - margin.bottom})`)
        .call(d3.axisBottom(xScale));

    svgChart.append("g")
        .attr("transform", `translate(${margin.left},0)`)
        .call(d3.axisLeft(yScale));

    // 工具提示
    const tooltip = d3.select("body").append("div").attr("class", "tooltip");

    function showTooltip(event, d) {
        tooltip
            .html(`${d['Town/estate']}<br>Elderly: ${d.Elderly}<br>Total: ${d.Total}`)
            .style("left", event.pageX + 10 + "px")
            .style("top", event.pageY + 10 + "px")
            .style("opacity", 1);
    }

    function hideTooltip() {
        tooltip.style("opacity", 0);
    }
});
</script>
</body>
</html>
