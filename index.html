<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Interactive Visualization: COE Premiums & Vehicle Population</title>
  <script src="https://d3js.org/d3.v6.min.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
      background: #f4f4f4;
    }
    .container {
      background: #fff;
      padding: 20px;
      margin-bottom: 20px;
      border-radius: 4px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    h2 { margin-top: 0; }
    .axis path, .axis line { fill: none; stroke: #000; }

    .checkbox-container { margin-bottom: 10px; }
    /* 为各部分添加边框 */
    #description, .checkbox-container, #chart-container {
      border: 1px solid #ddd;
      border-radius: 4px;
    }

    .line {
  stroke-linecap: round;
  stroke-linejoin: round;
}

.tooltip {
  background: rgba(255, 255, 255, 0.9);
  border: 1px solid #ddd;
  border-radius: 4px;
  box-shadow: 0 2px 6px rgba(0,0,0,0.1);
  pointer-events: none;
  transition: opacity 0.2s;
  padding: 12px;
  font-size: 14px;
}

.tooltip-header {
  font-weight: bold;
  margin-bottom: 8px;
  border-bottom: 1px solid #eee;
  padding-bottom: 4px;
}

.legend rect {
  stroke: #666;
  stroke-width: 0.5;
}

.focus-line {
  stroke-width: 1px;
}

.grid line {
  stroke: #eee;
}

.axis text {
  font-size: 12px;
  fill: #666;
}
  </style>
</head>
<body>
  <!-- 描述部分 -->
  <div id="description" class="container">
    <h2>Hypothesis and Data Description</h2>
    <p>
      I hypothesize that there is a positive correlation between COE premiums and the overall vehicle population in Singapore. As the vehicle population increases, the demand for vehicles intensifies, which may drive up COE premiums. Conversely, periods with a declining vehicle population might correspond with lower premiums.
    </p>
    <p>
      The analysis uses two datasets:
      <strong>COE Bidding Results / Prices</strong> (with month from Jan-10 to Mar-25, premium values)
      and <strong>Annual Motor Vehicle Population by Vehicle Type</strong> (with year from 2005 to 2025, vehicle numbers).
      The chart shows a dual-axis time series with the left y-axis representing COE Premiums and the right y-axis representing the aggregated total vehicles per year.
    </p>
  </div>
  
  <!-- 过滤选项 -->
  <div class="container checkbox-container">
    <label><input type="checkbox" id="toggleCoe" checked> Show COE Premiums</label>
    <label style="margin-left: 20px;"><input type="checkbox" id="toggleVehicle" checked> Show Total Vehicle Count</label>
  </div>
  
  <!-- 图表部分 -->
  <div id="chart-container" class="container">
    <svg id="chart" width="900" height="500"></svg>
    <div class="tooltip" id="tooltip"></div>
  </div>
  
  <script>
    // SVG 尺寸与边距
    const svgWidth = 900, svgHeight = 500;
    const margin = {top: 20, right: 60, bottom: 40, left: 60};
    const chartWidth = svgWidth - margin.left - margin.right;
    const chartHeight = svgHeight - margin.top - margin.bottom;
    
    // 创建 SVG 元素
    const svg = d3.select("#chart")
                  .attr("width", svgWidth)
                  .attr("height", svgHeight);
    const chartGroup = svg.append("g")
                          .attr("transform", `translate(${margin.left},${margin.top})`);
    
    // 定义日期解析函数
    const parseCoeDate = d3.timeParse("%Y-%m");  // 例如 "Jan-10" 会被解析为 2010-01-01
    const parseVehicleYear = d3.timeParse("%Y");
    
    // 清理行数据，去除键和值的多余空白
    function cleanRow(row) {
      const newRow = {};
      for (const key in row) {
        newRow[key.trim()] = typeof row[key] === "string" ? row[key].trim() : row[key];
      }
      return newRow;
    }
    
    // CSV 文件的 URL（请根据实际情况检查路径）
    const coeURL = "https://raw.githubusercontent.com/carionb/0322/main/COEBiddingResultsPrices.csv";
    const vehicleURL = "https://raw.githubusercontent.com/carionb/0322/main/AnnualMotorVehiclePopulationbyVehicleType.csv";
    
    // 加载 CSV 数据
    Promise.all([
      d3.csv(coeURL, cleanRow),
      d3.csv(vehicleURL, cleanRow)
    ]).then(([coeData, vehicleData]) => {
      console.log("First row of COE data:", coeData[0]);
      console.log("First row of Vehicle data:", vehicleData[0]);
      
      // 处理 COE 数据：解析 month 字段，转换 premium 数值
      coeData.forEach(d => {
        if (d.month) {
          // 为了保证解析正确，添加“-01”构造完整日期字符串（如 "Jan-10-01"），解析格式依然使用 "%Y-%m"
          // 注意：d3.timeParse("%Y-%m") 只需要前 7 个字符即可，所以直接解析 d.month 也行
          d.date = parseCoeDate(d.month);
          if (!d.date) {
            console.error("Date parsing failed for month:", d.month);
          }
        } else {
          console.error("No 'month' field in row:", d);
        }
        // 将 premium 转为数值，去除逗号
        if (d.premium) {
          d.premium = +d.premium.replace(/,/g, "");
        } else {
          d.premium = NaN;
        }
      });
      
      // 处理车辆数据：使用 "year" 和 "number"
      vehicleData.forEach(d => {
        if (d.year) {
          d.yearParsed = parseVehicleYear(d.year);
        } else {
          console.error("No 'year' field in row:", d);
        }
        // 将 "number" 转换为数字（去除逗号，如果有）
        d.number = d.number ? +d.number.replace(/,/g, "") : 0;
      });
      
      // 按年份聚合车辆数据（忽略 category 与 type）
      const aggregatedVehicleData = Array.from(
  d3.rollup(vehicleData, v => d3.sum(v, d => d.number), d => d.year
).map(([year, total]) => ({
  year: parseVehicleYear(year),
  // 生成每月数据点（平滑过渡）
  monthlyData: Array.from({length: 12}, (_, i) => ({
    date: new Date(year, i, 1),
    total: total
  }))
})).flatMap(d => d.monthlyData);

// 调整X轴时间范围
const xExtent = d3.extent([...coeData, ...aggregatedVehicleData].map(d => d.date));
const xScale = d3.scaleTime().domain(xExtent).range([0, chartWidth]).nice();

// 使用对数比例优化Y轴显示（假设数据范围差异大）
const yLeft = d3.scaleLog()
                .domain([1, d3.max(coeData, d => d.premium)])
                .range([chartHeight, 20]) // 保留顶部间距
                .nice();

const yRight = d3.scaleLinear()
                 .domain([0, d3.max(aggregatedVehicleData, d => d.total)])
                 .range([chartHeight, 20])
                 .nice();

// 增强折线样式
const lineCOE = d3.line()
  .x(d => xScale(d.date))
  .y(d => yLeft(d.premium))
  .curve(d3.curveMonotoneX); // 添加平滑曲线

const lineVehicle = d3.line()
  .x(d => xScale(d.date))
  .y(d => yRight(d.total))
  .curve(d3.curveMonotoneX);

// 添加渐变效果
const gradient = chartGroup.append("linearGradient")
  .attr("id", "coe-gradient")
  .attr("gradientUnits", "userSpaceOnUse")
  .attr("x1", 0).attr("y1", chartHeight)
  .attr("x2", 0).attr("y2", 0);

gradient.selectAll("stop")
  .data([{offset: "0%", color: "steelblue"}, {offset: "100%", color: "lightsteelblue"}])
  .enter().append("stop")
  .attr("offset", d => d.offset)
  .attr("stop-color", d => d.color);

// 绘制带填充的COE折线
chartGroup.append("path")
  .datum(coeData)
  .attr("class", "line coe-line")
  .style("stroke", "url(#coe-gradient)")
  .style("stroke-width", 3)
  .style("fill", "none")
  .attr("d", lineCOE);

// 添加动态焦点线
const focusLine = chartGroup.append("line")
  .attr("class", "focus-line")
  .style("stroke", "#666")
  .style("stroke-dasharray", "3 3")
  .style("opacity", 0);

// 优化提示框交互
chartGroup.append("rect")
  .attr("class", "overlay")
  .attr("width", chartWidth)
  .attr("height", chartHeight)
  .style("opacity", 0)
  .on("mousemove", function(event) {
    const mouseX = d3.pointer(event, this)[0];
    const bisect = d3.bisector(d => d.date).left;
    const x0 = xScale.invert(mouseX);
    
    // COE数据提示
    const coeIndex = bisect(coeData, x0, 1);
    const coeD = coeData[coeIndex];
    
    // 车辆数据提示
    const vehicleIndex = bisect(aggregatedVehicleData, x0, 1);
    const vehicleD = aggregatedVehicleData[vehicleIndex];

    focusLine.attr("x1", mouseX).attr("x2", mouseX)
      .attr("y1", 0).attr("y2", chartHeight)
      .style("opacity", 1);

    tooltip.html(`
      <div class="tooltip-header">${d3.timeFormat("%B %Y")(x0)}</div>
      <div style="color:steelblue">COE: $${coeD?.premium || 'N/A'}</div>
      <div style="color:orange">Vehicles: ${vehicleD?.total?.toLocaleString() || 'N/A'}</div>
    `).style("transform", `translate(${mouseX + 30}px, ${chartHeight/2}px)`);
  })
  .on("mouseout", () => {
    focusLine.style("opacity", 0);
    tooltip.style("opacity", 0);
  });

// 添加图例
const legend = chartGroup.append("g")
  .attr("class", "legend")
  .attr("transform", `translate(${chartWidth - 180}, 20)`);

legend.append("rect").attr("width", 18).attr("height", 18)
  .style("fill", "steelblue");
legend.append("text").attr("x", 24).attr("y", 9).attr("dy", ".35em")
  .text("COE Premiums");

legend.append("rect").attr("y", 20).attr("width", 18).attr("height", 18)
  .style("fill", "orange");
legend.append("text").attr("x", 24).attr("y", 29).attr("dy", ".35em")
  .text("Vehicle Population");

// 添加缩放功能
const zoom = d3.zoom()
  .scaleExtent([1, 8])
  .on("zoom", ({transform}) => {
    const newX = transform.rescaleX(xScale);
    chartGroup.selectAll(".line").attr("d", d => {
      if(d === coeData) return lineCOE.x(d => newX(d.date));
      return lineVehicle.x(d => newX(d.date));
    });
    chartGroup.select(".x.axis").call(xAxis.scale(newX));
  });

svg.call(zoom);
      
      // 复选框交互：切换系列显示
      d3.select("#toggleCoe").on("change", function() {
        const display = this.checked ? "visible" : "hidden";
        chartGroup.selectAll(".coe-line, .dot-coe").style("visibility", display);
      });
      
      d3.select("#toggleVehicle").on("change", function() {
        const display = this.checked ? "visible" : "hidden";
        chartGroup.selectAll(".vehicle-line, .dot-vehicle").style("visibility", display);
      });
      
    }).catch(error => {
      console.error("Error loading CSV data:", error);
    });
  </script>
</body>
</html>
