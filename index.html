<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Interactive Visualization: COE Premiums & Vehicle Population</title>
  <script src="https://d3js.org/d3.v6.min.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
      background: #f4f4f4;
    }
    .container {
      background: #fff;
      padding: 20px;
      margin-bottom: 20px;
      border-radius: 4px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    h2 { margin-top: 0; }
    .axis path, .axis line { fill: none; stroke: #000; }
    .grid line { stroke: #ccc; stroke-dasharray: 3 3; }
    .line { fill: none; stroke-width: 2px; }
    .tooltip {
      position: absolute;
      text-align: center;
      background: lightsteelblue;
      padding: 5px;
      border: 1px solid #000;
      pointer-events: none;
      opacity: 0;
    }
    .checkbox-container { margin-bottom: 10px; }
    /* 为各部分添加边框 */
    #description, .checkbox-container, #chart-container {
      border: 1px solid #ddd;
      border-radius: 4px;
    }
  </style>
</head>
<body>
  <!-- 描述部分 -->
  <div id="description" class="container">
    <h2>Hypothesis and Data Description</h2>
    <p>
      I hypothesize that there is a positive correlation between COE premiums and the overall vehicle population in Singapore. As the vehicle population increases, the demand for vehicles intensifies, which may drive up COE premiums. Conversely, periods with a declining vehicle population might correspond with lower premiums.
    </p>
    <p>
      The analysis uses two datasets:
      <strong>COE Bidding Results / Prices</strong> (month from Jan-10 to Mar-25, premium values)
      and <strong>Annual Motor Vehicle Population by Vehicle Type</strong> (year from 2005 to 2025, vehicle numbers).
      The chart shows a dual-axis time series with the left y-axis representing COE Premiums and the right y-axis representing the aggregated total vehicles per year.
    </p>
  </div>
  
  <!-- 过滤选项 -->
  <div class="container checkbox-container">
    <label><input type="checkbox" id="toggleCoe" checked> Show COE Premiums</label>
    <label style="margin-left: 20px;"><input type="checkbox" id="toggleVehicle" checked> Show Total Vehicle Count</label>
  </div>
  
  <!-- 图表部分 -->
  <div id="chart-container" class="container">
    <svg id="chart" width="900" height="500"></svg>
    <div class="tooltip" id="tooltip"></div>
  </div>
  
  <script>
    // SVG 尺寸
    const svgWidth = 900, svgHeight = 500;
    
    // 定义边距
    const margin = {top: 20, right: 60, bottom: 40, left: 60};
    const chartWidth = svgWidth - margin.left - margin.right;
    const chartHeight = svgHeight - margin.top - margin.bottom;
    
    // 创建 SVG
    const svg = d3.select("#chart")
                  .attr("width", svgWidth)
                  .attr("height", svgHeight);
    
    // 创建一个组，用于存放图表（平移 margin）
    const chartGroup = svg.append("g")
                          .attr("transform", `translate(${margin.left},${margin.top})`);
    
    // 定义日期解析函数
    const parseMonth = d3.timeParse("%b-%y"); // 解析 COE 的 "month" 字段，如 "Jan-10"
    const parseYear = d3.timeParse("%Y");      // 解析车辆数据 "year"
    
    // 清理每行数据：去除键和值的空格
    function cleanRow(row) {
      const newRow = {};
      for (const key in row) {
        newRow[key.trim()] = typeof row[key] === "string" ? row[key].trim() : row[key];
      }
      return newRow;
    }
    
    // 加载 CSV 数据（请确认仓库公开，并使用 raw 链接）
    Promise.all([
      d3.csv("https://raw.githubusercontent.com/carionb/0322/main/COEBiddingResultsPrices.csv", cleanRow),
      d3.csv("https://raw.githubusercontent.com/carionb/0322/main/AnnualMotorVehiclePopulationbyVehicleType.csv", cleanRow)
    ]).then(([coeData, vehicleData]) => {
      console.log("First row of COE data:", coeData[0]);
      console.log("First row of Vehicle data:", vehicleData[0]);
      
      // 处理 COE 数据
      coeData.forEach(d => {
        if (d.month) {
          d.date = parseMonth(d.month);
          if (!d.date) {
            console.error("Date parsing failed for month:", d.month);
          }
        } else {
          console.error("No 'month' field in row:", d);
        }
        // 处理 premium 数值（去除逗号，并转换为数字）
        if (d.premium) {
          d.premium = +d.premium.replace(/,/g, "");
        } else {
          d.premium = NaN;
        }
      });
      
      // 处理车辆数据
      // 注意：车辆 CSV字段： "year", "category", "type", "No. of Vehicles"
      vehicleData.forEach(d => {
        if (d.year) {
          d.yearParsed = parseYear(d.year);
        } else {
          console.error("No 'year' field in row:", d);
        }
        // 将 "No. of Vehicles" 转为数字（假设没有逗号）
        d.number = d["No. of Vehicles"] ? +d["No. of Vehicles"].replace(/,/g, "") : 0;
      });
      
      // 按年份聚合车辆数据（求和 "number"）
      const aggregatedVehicle = Array.from(
        d3.rollup(vehicleData, v => d3.sum(v, d => d.number), d => d.year),
        ([year, total]) => ({ year: parseYear(year), total })
      );
      
      console.log("Aggregated Vehicle Data:", aggregatedVehicle);
      
      // 定义 x 轴的时间范围：取两数据集中日期的最小值和最大值
      const xMin = d3.min([d3.min(coeData, d => d.date), d3.min(aggregatedVehicle, d => d.year)]);
      const xMax = d3.max([d3.max(coeData, d => d.date), d3.max(aggregatedVehicle, d => d.year)]);
      
      const xScale = d3.scaleTime()
                       .domain([xMin, xMax])
                       .range([0, chartWidth]);
      
      // y 轴比例尺
      const yLeft = d3.scaleLinear()
                      .domain([0, d3.max(coeData, d => d.premium)]).nice()
                      .range([chartHeight, 0]);
      
      const yRight = d3.scaleLinear()
                       .domain([0, d3.max(aggregatedVehicle, d => d.total)]).nice()
                       .range([chartHeight, 0]);
      
      // 定义坐标轴
      const xAxis = d3.axisBottom(xScale);
      const yAxisLeft = d3.axisLeft(yLeft);
      const yAxisRight = d3.axisRight(yRight);
      
      // 添加 x 轴
      chartGroup.append("g")
                .attr("class", "x axis")
                .attr("transform", `translate(0, ${chartHeight})`)
                .call(xAxis);
      
      // 添加左侧 y 轴
      chartGroup.append("g")
                .attr("class", "y axis left")
                .call(yAxisLeft)
                .append("text")
                .attr("fill", "steelblue")
                .attr("transform", "rotate(-90)")
                .attr("y", -50)
                .attr("dy", "0.71em")
                .attr("text-anchor", "end")
                .text("COE Premium");
      
      // 添加右侧 y 轴
      chartGroup.append("g")
                .attr("class", "y axis right")
                .attr("transform", `translate(${chartWidth},0)`)
                .call(yAxisRight)
                .append("text")
                .attr("fill", "orange")
                .attr("transform", "rotate(-90)")
                .attr("y", 40)
                .attr("dy", "0.71em")
                .attr("text-anchor", "end")
                .text("Total Vehicles");
      
      // 添加网格线（可选）
      function make_x_gridlines() { return d3.axisBottom(xScale).ticks(5); }
      function make_y_gridlines() { return d3.axisLeft(yLeft).ticks(5); }
      
      chartGroup.append("g")
                .attr("class", "grid")
                .attr("transform", `translate(0, ${chartHeight})`)
                .call(make_x_gridlines().tickSize(-chartHeight).tickFormat(""));
      
      chartGroup.append("g")
                .attr("class", "grid")
                .call(make_y_gridlines().tickSize(-chartWidth).tickFormat(""));
      
      // 定义折线生成器
      const lineCOE = d3.line()
                        .x(d => xScale(d.date))
                        .y(d => yLeft(d.premium));
      
      const lineVehicle = d3.line()
                            .x(d => xScale(d.year))
                            .y(d => yRight(d.total));
      
      // 绘制 COE 折线
      chartGroup.append("path")
                .datum(coeData)
                .attr("class", "line coe-line")
                .attr("stroke", "steelblue")
                .attr("d", lineCOE);
      
      // 绘制 车辆总量折线
      chartGroup.append("path")
                .datum(aggregatedVehicle)
                .attr("class", "line vehicle-line")
                .attr("stroke", "orange")
                .attr("d", lineVehicle);
      
      // 添加 tooltip
      const tooltip = d3.select("#tooltip");
      
      // COE 数据 tooltip 圆点
      chartGroup.selectAll(".dot-coe")
                .data(coeData)
                .enter()
                .append("circle")
                .attr("class", "dot-coe")
                .attr("cx", d => xScale(d.date))
                .attr("cy", d => yLeft(d.premium))
                .attr("r", 3)
                .attr("fill", "steelblue")
                .on("mouseover", (event, d) => {
                  tooltip.transition().duration(200).style("opacity", 0.9);
                  tooltip.html(`Month: ${d3.timeFormat("%b-%y")(d.date)}<br/>Premium: ${d.premium}`)
                         .style("left", (event.pageX + 10) + "px")
                         .style("top", (event.pageY - 28) + "px");
                })
                .on("mouseout", () => {
                  tooltip.transition().duration(500).style("opacity", 0);
                });
      
      // 车辆数据 tooltip 圆点
      chartGroup.selectAll(".dot-vehicle")
                .data(aggregatedVehicle)
                .enter()
                .append("circle")
                .attr("class", "dot-vehicle")
                .attr("cx", d => xScale(d.year))
                .attr("cy", d => yRight(d.total))
                .attr("r", 3)
                .attr("fill", "orange")
                .on("mouseover", (event, d) => {
                  tooltip.transition().duration(200).style("opacity", 0.9);
                  tooltip.html(`Year: ${d3.timeFormat("%Y")(d.year)}<br/>Total: ${d.total}`)
                         .style("left", (event.pageX + 10) + "px")
                         .style("top", (event.pageY - 28) + "px");
                })
                .on("mouseout", () => {
                  tooltip.transition().duration(500).style("opacity", 0);
                });
      
      // 复选框过滤功能
      d3.select("#toggleCoe").on("change", function() {
        const display = this.checked ? null : "none";
        chartGroup.selectAll(".coe-line").style("display", display);
        chartGroup.selectAll(".dot-coe").style("display", display);
      });
      
      d3.select("#toggleVehicle").on("change", function() {
        const display = this.checked ? null : "none";
        chartGroup.selectAll(".vehicle-line").style("display", display);
        chartGroup.selectAll(".dot-vehicle").style("display", display);
      });
      
    }).catch(error => {
      console.error("Error loading CSV data:", error);
    });
  </script>
</body>
</html>
