<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Interactive Visualization: COE Premiums & Vehicle Population</title>
  <script src="https://d3js.org/d3.v6.min.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
      background: #f4f4f4;
    }
    .container {
      background: #fff;
      padding: 20px;
      margin-bottom: 20px;
      border-radius: 4px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    h2 { margin-top: 0; }
    .axis path, .axis line { fill: none; stroke: #000; }
    .grid line { stroke: #ccc; stroke-dasharray: 3 3; }
    .line { fill: none; stroke-width: 2px; }
    .tooltip {
      position: absolute;
      background: lightsteelblue;
      padding: 5px;
      border: 1px solid #000;
      pointer-events: none;
      opacity: 0;
    }
    .checkbox-container { margin-bottom: 10px; }
    /* 为各部分添加边框 */
    #description, .checkbox-container, #chart-container {
      border: 1px solid #ddd;
      border-radius: 4px;
    }
  </style>
</head>
<body>
  <!-- 描述部分 -->
  <div id="description" class="container">
    <h2>Hypothesis and Data Description</h2>
    <p>
      I hypothesize that there is a positive correlation between COE premiums and the overall vehicle population in Singapore.
      As the vehicle population increases, the demand for vehicles intensifies, which may drive up COE premiums.
      Notably, the definitions for COE categories changed in May 2022.
    </p>
    <p>
      The visualization uses two datasets:
      <strong>COE Bidding Results / Prices</strong> (with month values from Jan-10 to Mar-25) and
      <strong>Annual Motor Vehicle Population by Vehicle Type</strong> (with year values from 2005 to 2025).
      The left y-axis shows the premium for each COE category (A, B, C, D, E) and the right y-axis shows
      the aggregated total vehicle count.
    </p>
  </div>
  
  <!-- 过滤选项 -->
  <div class="container checkbox-container">
    <label><input type="checkbox" id="toggleCoe" checked> Show COE Premiums</label>
    <label style="margin-left: 20px;"><input type="checkbox" id="toggleVehicle" checked> Show Total Vehicle Count</label>
  </div>
  
  <!-- 图表部分 -->
  <div id="chart-container" class="container">
    <svg id="chart" width="900" height="500"></svg>
    <div class="tooltip" id="tooltip"></div>
  </div>
  
  <script>
    // SVG 尺寸与边距
    const svgWidth = 900, svgHeight = 500;
    const margin = {top: 20, right: 60, bottom: 40, left: 60};
    const chartWidth = svgWidth - margin.left - margin.right;
    const chartHeight = svgHeight - margin.top - margin.bottom;
    
    // 创建 SVG 元素
    const svg = d3.select("#chart")
                  .attr("width", svgWidth)
                  .attr("height", svgHeight);
    const chartGroup = svg.append("g")
                          .attr("transform", `translate(${margin.left},${margin.top})`);
    
    // 定义日期解析函数
    const parseCoeDate = d3.timeParse("%b-%y");  // 如 "Jan-10"
    const parseVehicleYear = d3.timeParse("%Y");   // 如 "2005"
    
    // 清理行数据：去除键和值的多余空格
    function cleanRow(row) {
      const newRow = {};
      for (const key in row) {
        newRow[key.trim()] = typeof row[key] === "string" ? row[key].trim() : row[key];
      }
      return newRow;
    }
    
    // CSV 文件的 URL
    const coeURL = "https://raw.githubusercontent.com/carionb/0322/main/COEBiddingResultsPrices.csv";
    const vehicleURL = "https://raw.githubusercontent.com/carionb/0322/main/AnnualMotorVehiclePopulationbyVehicleType.csv";
    
    // 加载 CSV 数据
    Promise.all([
      d3.csv(coeURL, cleanRow),
      d3.csv(vehicleURL, cleanRow)
    ]).then(([coeData, vehicleData]) => {
      console.log("First row of COE data:", coeData[0]);
      console.log("First row of Vehicle data:", vehicleData[0]);
      
      // 处理 COE 数据
      // 这里使用字段 "month" 与 "premium"
      coeData.forEach(d => {
        if (d.month) {
          d.date = parseCoeDate(d.month);
          if (!d.date) {
            console.error("Date parsing failed for month:", d.month);
          }
        } else {
          console.error("No 'month' field in row:", d);
        }
        // 将 premium 转为数值（去除逗号）
        if (d.premium) {
          d.premium = +d.premium.replace(/,/g, "");
        } else {
          d.premium = NaN;
        }
      });
      
      // 处理车辆数据
      // 车辆 CSV字段： "year", "category", "type", "number"
      vehicleData.forEach(d => {
        if (d.year) {
          d.yearParsed = parseVehicleYear(d.year);
        } else {
          console.error("No 'year' field in row:", d);
        }
        // 将 "number" 转为数字（去除逗号）
        d.number = d.number ? +d.number.replace(/,/g, "") : 0;
      });
      
      // 按年份聚合车辆数据（忽略 category 与 type）
      const aggregatedVehicleData = Array.from(
        d3.rollup(vehicleData, v => d3.sum(v, d => d.number), d => d.year),
        ([year, total]) => ({ year: parseVehicleYear(year), total })
      ).sort((a, b) => a.year - b.year);
      
      console.log("Aggregated Vehicle Data:", aggregatedVehicleData);
      
      // 为 COE 数据按 vehicle_class 分组
      const coeByCategory = d3.groups(coeData, d => d.vehicle_class);
      // coeByCategory: [ [ "Category A", [rows...] ], [ "Category B", [rows...] ], ... ]
      
      // 定义颜色比例尺
      const colorScale = d3.scaleOrdinal(d3.schemeCategory10)
                           .domain(coeByCategory.map(d => d[0]));
      
      // 定义 x 轴时间范围
      const xMin = d3.min([d3.min(coeData, d => d.date), d3.min(aggregatedVehicleData, d => d.year)]);
      const xMax = d3.max([d3.max(coeData, d => d.date), d3.max(aggregatedVehicleData, d => d.year)]);
      const xScale = d3.scaleTime().domain([xMin, xMax]).range([0, chartWidth]);
      
      // 定义左侧 y 轴比例尺（COE Premium）
      const yLeft = d3.scaleLinear()
                      .domain([0, d3.max(coeData, d => d.premium)]).nice()
                      .range([chartHeight, 0]);
      
      // 定义右侧 y 轴比例尺（车辆总数）
      const yRight = d3.scaleLinear()
                       .domain([0, d3.max(aggregatedVehicleData, d => d.total)]).nice()
                       .range([chartHeight, 0]);
      
      // 添加坐标轴
      const xAxis = d3.axisBottom(xScale);
      const yAxisLeft = d3.axisLeft(yLeft).tickFormat(d => `$${d3.format(".2s")(d)}`);
      const yAxisRight = d3.axisRight(yRight).tickFormat(d3.format(".2s"));
      
      chartGroup.append("g")
                .attr("class", "x axis")
                .attr("transform", `translate(0, ${chartHeight})`)
                .call(xAxis);
      
      chartGroup.append("g")
                .attr("class", "y axis left")
                .call(yAxisLeft)
                .append("text")
                .attr("transform", "rotate(-90)")
                .attr("y", -50)
                .attr("dy", "0.71em")
                .attr("text-anchor", "end")
                .attr("fill", "steelblue")
                .text("COE Premium");
      
      chartGroup.append("g")
                .attr("class", "y axis right")
                .attr("transform", `translate(${chartWidth}, 0)`)
                .call(yAxisRight)
                .append("text")
                .attr("transform", "rotate(-90)")
                .attr("y", 40)
                .attr("dy", "0.71em")
                .attr("text-anchor", "end")
                .attr("fill", "orange")
                .text("Total Vehicles");
      
      // 添加网格线
      function make_x_gridlines() { return d3.axisBottom(xScale).ticks(5); }
      function make_y_gridlines() { return d3.axisLeft(yLeft).ticks(5); }
      
      chartGroup.append("g")
                .attr("class", "grid")
                .attr("transform", `translate(0, ${chartHeight})`)
                .call(make_x_gridlines().tickSize(-chartHeight).tickFormat(""));
      
      chartGroup.append("g")
                .attr("class", "grid")
                .call(make_y_gridlines().tickSize(-chartWidth).tickFormat(""));
      
      // 定义折线生成器
      const lineGenerator = d3.line()
                              .x(d => xScale(d.date))
                              .y(d => yLeft(d.premium));
      
      const lineVehicle = d3.line()
                            .x(d => xScale(d.year))
                            .y(d => yRight(d.total));
      
      // 绘制每个 COE 类别的折线（多条折线图）
      coeByCategory.forEach(([cat, rows]) => {
        // 对每组数据按日期排序
        rows.sort((a, b) => a.date - b.date);
        chartGroup.append("path")
                  .datum(rows)
                  .attr("class", "line coe-line")
                  .attr("stroke", colorScale(cat))
                  .attr("fill", "none")
                  .attr("d", lineGenerator);
      });
      
      // 绘制车辆聚合折线（右侧 y 轴）
      chartGroup.append("path")
                .datum(aggregatedVehicleData)
                .attr("class", "line vehicle-line")
                .attr("stroke", "orange")
                .attr("fill", "none")
                .attr("d", lineVehicle);
      
      // 添加垂直注释线，标注定义变化：2022年5月
      const changeDate = parseCoeDate("May-22");
      chartGroup.append("line")
                .attr("x1", xScale(changeDate))
                .attr("x2", xScale(changeDate))
                .attr("y1", 0)
                .attr("y2", chartHeight)
                .attr("stroke", "red")
                .attr("stroke-dasharray", "4,4");
      
      chartGroup.append("text")
                .attr("x", xScale(changeDate) + 5)
                .attr("y", 20)
                .attr("fill", "red")
                .text("Definition changed in May 2022");
      
      // 添加 tooltip
      const tooltip = d3.select("#tooltip");
      
      // COE tooltip 圆点
      chartGroup.selectAll(".dot-coe")
                .data(coeData)
                .enter()
                .append("circle")
                .attr("class", "dot-coe")
                .attr("cx", d => xScale(d.date))
                .attr("cy", d => yLeft(d.premium))
                .attr("r", 3)
                .attr("fill", d => colorScale(d.vehicle_class))
                .on("mouseover", (event, d) => {
                  tooltip.transition().duration(200).style("opacity", 0.9);
                  tooltip.html(`Month: ${d3.timeFormat("%b %Y")(d.date)}<br/>Category: ${d.vehicle_class}<br/>Premium: $${d.premium}`)
                         .style("left", `${event.pageX + 10}px`)
                         .style("top", `${event.pageY - 28}px`);
                })
                .on("mouseout", () => {
                  tooltip.transition().duration(500).style("opacity", 0);
                });
      
      // 车辆 tooltip 圆点
      chartGroup.selectAll(".dot-vehicle")
                .data(aggregatedVehicleData)
                .enter()
                .append("circle")
                .attr("class", "dot-vehicle")
                .attr("cx", d => xScale(d.year))
                .attr("cy", d => yRight(d.total))
                .attr("r", 3)
                .attr("fill", "orange")
                .on("mouseover", (event, d) => {
                  tooltip.transition().duration(200).style("opacity", 0.9);
                  tooltip.html(`Year: ${d3.timeFormat("%Y")(d.year)}<br/>Total Vehicles: ${d.total}`)
                         .style("left", `${event.pageX + 10}px`)
                         .style("top", `${event.pageY - 28}px`);
                })
                .on("mouseout", () => {
                  tooltip.transition().duration(500).style("opacity", 0);
                });
      
      // 复选框交互：切换显示 COE 折线和车辆折线
      d3.select("#toggleCoe").on("change", function() {
        const display = this.checked ? "visible" : "hidden";
        chartGroup.selectAll(".coe-line, .dot-coe").style("visibility", display);
      });
      
      d3.select("#toggleVehicle").on("change", function() {
        const display = this.checked ? "visible" : "hidden";
        chartGroup.selectAll(".vehicle-line, .dot-vehicle").style("visibility", display);
      });
      
    }).catch(error => {
      console.error("Error loading CSV data:", error);
    });
  </script>
</body>
</html>
