<!DOCTYPE html>
<html>
<head>
    <title>Singapore Elderly Population Map</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        .map-container { 
            width: 1200px;
            height: 1000px;
            border: 1px solid #ccc;
        }
        .tooltip {
            position: absolute;
            padding: 8px;
            background: rgba(255,255,255,0.9);
            border: 1px solid #ddd;
            pointer-events: none;
            font-family: Arial;
            box-shadow: 2px 2px 5px rgba(0,0,0,0.2);
        }
    </style>
</head>
<body>
    <div id="map-container"></div>

<script>
// åˆå§‹åŒ–é…ç½®
const width = 1200, height = 1000;

// åŠ è½½æ•°æ®
Promise.all([
    d3.csv("https://raw.githubusercontent.com/carionb/0322/main/elderly.csv", d3.autoType),
    d3.json("https://raw.githubusercontent.com/carionb/0322/main/sgmap.json")
]).then(([elderlyData, geoData]) => {
    
    // è°ƒè¯•è¾“å‡º
    console.log("GeoJSONå±æ€§å­—æ®µç¤ºä¾‹:", geoData.features[0].properties);
    console.log("CSVå­—æ®µç¤ºä¾‹:", elderlyData[0]);

    // åˆ›å»ºæŠ•å½±ï¼ˆæ ¹æ®æ–°æ•°æ®ä¼˜åŒ–ï¼‰
    const projection = d3.geoMercator()
        .center([103.8, 1.35])  // æ–°åŠ å¡ä¸­å¿ƒåæ ‡
        .scale(45000)           // è°ƒæ•´åçš„æœ€ä½³ç¼©æ”¾æ¯”ä¾‹
        .translate([width/2, height/2]);

    const path = d3.geoPath().projection(projection);

    // åˆ›å»ºSVGå®¹å™¨
    const svg = d3.select("#map-container")
        .append("svg")
        .attr("width", width)
        .attr("height", height);

    // ç»˜åˆ¶åœ°å›¾è¾¹ç•Œ
    svg.selectAll("path")
        .data(geoData.features)
        .enter().append("path")
        .attr("d", path)
        .attr("fill", "#f8f8f8")
        .attr("stroke", "#666")
        .attr("stroke-width", 0.5);

    // åˆ›å»ºåç§°åŒ¹é…ç³»ç»Ÿ
    const normalizeName = (name) => 
        name.trim().toUpperCase().replace(/[^A-Z]/g, "");

    // æ„å»ºåŒºåŸŸåæ ‡æ˜ å°„
    const areaMap = new Map();
    geoData.features.forEach(feature => {
        const rawName = feature.properties.PLN_AREA_N; // å…³é”®å­—æ®µ
        if (rawName) {
            const normalized = normalizeName(rawName);
            const centroid = d3.geoCentroid(feature);
            areaMap.set(normalized, {
                centroid: centroid,
                feature: feature
            });
        }
    });

    // è°ƒè¯•è¾“å‡ºåŒ¹é…ç»“æœ
    console.log("GeoJSONåŒºåŸŸåˆ—è¡¨:", Array.from(areaMap.keys()));
    console.log("CSVåŒºåŸŸåˆ—è¡¨:", 
        [...new Set(elderlyData.map(d => normalizeName(d['Town/estate'])))]);

    // åˆ›å»ºé¢œè‰²æ¯”ä¾‹å°º
    const maxRatio = d3.max(elderlyData, d => d.Elderly/d.Total);
    const colorScale = d3.scaleSequential(d3.interpolateReds)
        .domain([0, maxRatio]);

    // æ·»åŠ æ•°æ®ç‚¹ï¼ˆä½¿ç”¨2018å¹´æ•°æ®ï¼‰
    svg.selectAll("circle")
        .data(elderlyData.filter(d => d.SHS_year === 2018))
        .enter().append("circle")
        .attr("cx", d => {
            const key = normalizeName(d['Town/estate']);
            const info = areaMap.get(key);
            return info ? projection(info.centroid)[0] : -1000;
        })
        .attr("cy", d => {
            const key = normalizeName(d['Town/estate']);
            const info = areaMap.get(key);
            return info ? projection(info.centroid)[1] : -1000;
        })
        .attr("r", d => Math.sqrt(d.Total)/50) // åŠå¾„æŒ‰æ€»äººå£ç¼©æ”¾
        .attr("fill", d => colorScale(d.Elderly/d.Total))
        .attr("stroke", "#333")
        .attr("stroke-width", 0.5)
        .attr("opacity", 0.8)
        .on("mouseover", function(event, d) {
            d3.select(this).attr("r", Math.sqrt(d.Total)/40);
            showTooltip(event, d);
        })
        .on("mouseout", function(event, d) {
            d3.select(this).attr("r", Math.sqrt(d.Total)/50);
            hideTooltip();
        });

    // æ·»åŠ å›¾ä¾‹
    const legend = svg.append("g")
        .attr("transform", "translate(50,50)");

    const legendScale = d3.scaleLinear()
        .domain([0, maxRatio])
        .range([0, 200]);

    legend.selectAll("rect")
        .data(d3.range(0, 1, 0.1))
        .enter().append("rect")
        .attr("x", d => legendScale(d))
        .attr("y", 0)
        .attr("width", 20)
        .attr("height", 15)
        .attr("fill", d => d3.interpolateReds(d));

    legend.append("text")
        .attr("x", 0)
        .attr("y", -5)
        .text("è€å¹´äººå£æ¯”ä¾‹");

    // å·¥å…·æç¤º
    const tooltip = d3.select("body").append("div").attr("class", "tooltip");

    function showTooltip(event, d) {
        tooltip
            .html(`
                <div style="color:#333">
                    <h4>${d['Town/estate']}</h4>
                    <p>ğŸ™ï¸ æ€»äººå£: ${d.Total.toLocaleString()}</p>
                    <p>ğŸ‘µ è€å¹´äººå£: ${d.Elderly.toLocaleString()}</p>
                    <p>ğŸ“ˆ è€å¹´æ¯”ä¾‹: ${(d.Elderly/d.Total*100).toFixed(1)}%</p>
                </div>
            `)
            .style("left", event.pageX + 20 + "px")
            .style("top", event.pageY + 20 + "px")
            .style("opacity", 1);
    }

    function hideTooltip() {
        tooltip.style("opacity", 0);
    }

}).catch(error => {
    console.error("é”™è¯¯è¯¦æƒ…:", error);
    alert("æ•°æ®åŠ è½½å¤±è´¥ï¼Œè¯·æŸ¥çœ‹æ§åˆ¶å°");
});
</script>
</body>
</html>
