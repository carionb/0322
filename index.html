<!DOCTYPE html>
<html>
<head>
    <title>Singapore Elderly Population Map</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        .map-container { 
            width: 1000px;
            height: 800px;
            border: 1px solid #ccc;
        }
        .tooltip {
            position: absolute;
            padding: 8px;
            background: white;
            border: 1px solid #ddd;
            pointer-events: none;
            font-family: Arial;
        }
    </style>
</head>
<body>
    <div id="map-container"></div>

<script>
// 初始化配置
const width = 1000, height = 800;

// 加载数据
Promise.all([
    d3.csv("https://raw.githubusercontent.com/carionb/0322/main/elderly.csv", d3.autoType),
    d3.json("https://raw.githubusercontent.com/carionb/0322/main/sgmap.json")
]).then(([elderlyData, geoData]) => {
    
    // 调试输出
    console.log("GeoJSON属性字段示例:", geoData.features[0].properties);
    console.log("CSV字段示例:", elderlyData[0]);

    // 创建投影（根据新加坡坐标优化）
    const projection = d3.geoMercator()
        .center([103.8, 1.35])  // 新加坡中心坐标
        .scale(35000)
        .translate([width/2, height/2]);

    const path = d3.geoPath().projection(projection);

    // 创建SVG容器
    const svg = d3.select("#map-container")
        .append("svg")
        .attr("width", width)
        .attr("height", height);

    // 绘制地图边界
    svg.selectAll("path")
        .data(geoData.features)
        .enter().append("path")
        .attr("d", path)
        .attr("fill", "#f0f0f0")
        .attr("stroke", "#666");

    // 创建名称匹配系统
    const normalizeName = (name) => 
        name.trim().toUpperCase().replace(/\s+/g, "_");

    // 构建规划区坐标映射
    const planningAreaMap = new Map();
    geoData.features.forEach(feature => {
        const areaName = feature.properties["Planning Area Name"];
        if (areaName) {
            const centroid = d3.geoCentroid(feature);
            planningAreaMap.set(normalizeName(areaName), {
                centroid: centroid,
                feature: feature
            });
        }
    });

    // 调试输出匹配结果
    console.log("GeoJSON规划区名称:", 
        Array.from(planningAreaMap.keys()));
    console.log("CSV中的地区名称:", 
        elderlyData.map(d => normalizeName(d['Town/estate'])));

    // 添加数据点
    svg.selectAll("circle")
        .data(elderlyData.filter(d => d.SHS_year === 2018))
        .enter().append("circle")
        .attr("cx", d => {
            const key = normalizeName(d['Town/estate']);
            const info = planningAreaMap.get(key);
            return info ? projection(info.centroid)[0] : -1000;
        })
        .attr("cy", d => {
            const key = normalizeName(d['Town/estate']);
            const info = planningAreaMap.get(key);
            return info ? projection(info.centroid)[1] : -1000;
        })
        .attr("r", 8)
        .attr("fill", d => d3.interpolateReds(d.Elderly/d.Total))
        .attr("stroke", "#333")
        .on("mouseover", function(event, d) {
            d3.select(this).attr("r", 12);
            showTooltip(event, d);
        })
        .on("mouseout", function(event, d) {
            d3.select(this).attr("r", 8);
            hideTooltip();
        });

    // 工具提示
    const tooltip = d3.select("body").append("div").attr("class", "tooltip");

    function showTooltip(event, d) {
        tooltip
            .html(`
                <strong>${d['Town/estate']}</strong><br>
                老年人口: ${d.Elderly.toLocaleString()}<br>
                总人口: ${d.Total.toLocaleString()}<br>
                占比: ${(d.Elderly/d.Total*100).toFixed(1)}%
            `)
            .style("left", event.pageX + 15 + "px")
            .style("top", event.pageY + 15 + "px")
            .style("opacity", 1);
    }

    function hideTooltip() {
        tooltip.style("opacity", 0);
    }

}).catch(error => {
    console.error("错误详情:", error);
    alert("数据加载失败，请查看控制台");
});
</script>
</body>
</html>
