<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>COE Prices & Vehicle Population Analysis</title>
  <script src="https://d3js.org/d3.v6.min.js"></script>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 40px;
      background: #f8f9fa;
    }
    .dashboard {
      background: white;
      padding: 30px;
      border-radius: 12px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }
    .controls {
      display: flex;
      gap: 20px;
      margin-bottom: 30px;
    }
    .control-group {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    select {
      padding: 8px 12px;
      border-radius: 6px;
      border: 1px solid #ced4da;
      background: white;
    }
    .axis-label {
      font-size: 14px;
      fill: #6c757d;
    }
    .grid line {
      stroke: #e9ecef;
      stroke-dasharray: 3 3;
    }
    .tooltip {
      position: absolute;
      padding: 12px;
      background: rgba(0,0,0,0.8);
      color: white;
      border-radius: 4px;
      pointer-events: none;
      font-size: 14px;
    }
    .line {
      fill: none;
      stroke-width: 2;
      transition: opacity 0.3s;
    }
  </style>
</head>
<body>
  <div class="dashboard">
    <div class="controls">
      <!-- 此处可加入下拉筛选，目前未细化到车辆数据细分 -->
      <!-- 示例中不对车辆数据进行进一步筛选 -->
    </div>
    <svg width="1000" height="600"></svg>
  </div>

<script>
// 配置参数
const config = {
  width: 1000,
  height: 600,
  margin: {top: 60, right: 100, bottom: 100, left: 80},
  transitionDuration: 500
};

// 初始化SVG
const svg = d3.select("svg")
  .attr("width", config.width)
  .attr("height", config.height);

// 计算绘图区域尺寸
const innerWidth = config.width - config.margin.left - config.margin.right;
const innerHeight = config.height - config.margin.top - config.margin.bottom;

// 创建主绘图区域
const chart = svg.append("g")
  .attr("transform", `translate(${config.margin.left},${config.margin.top})`);

// 定义日期解析函数
const parseCoeDate = d3.timeParse("%b-%y"); // 如 "Jan-10"
const parseVehicleYear = d3.timeParse("%Y");  // 如 "2005"

// CSV 文件的 URL（请根据实际情况检查路径）
const coeURL = "https://raw.githubusercontent.com/carionb/0322/main/COEBiddingResultsPrices.csv";
const vehicleURL = "https://raw.githubusercontent.com/carionb/0322/main/AnnualMotorVehiclePopulationbyVehicleType.csv";

// 使用 d3.autoType 读取数据
Promise.all([
  d3.csv(coeURL, d3.autoType),
  d3.csv(vehicleURL, d3.autoType)
]).then(([coeData, vehicleData]) => {
  console.log("First row of COE data:", coeData[0]);
  console.log("First row of Vehicle data:", vehicleData[0]);
  
  // 处理 COE 数据
  // 使用字段 "month" 和 "premium"（注意 CSV 中列名区分大小写）
  const processedCoeData = coeData.map(d => {
    return {
      date: parseCoeDate(d.Month),  // 例如 "Jan-10"
      vehicle_class: d["Vehicle Class"],
      premium: d.Premium
    };
  }).filter(d => d.date); // 过滤日期解析失败的行

  // 处理车辆数据：将 "year" 转换为日期对象（以当年1月1日表示）
  const processedVehicleData = vehicleData.map(d => {
    return {
      year: new Date(d.year, 0, 1), // 将数字年份转换为日期
      Category: d.Category,
      Type: d.Type,
      number: d.number
    };
  });

  // 按年份聚合车辆数据（忽略 Category 与 Type）
  const aggregatedVehicleData = Array.from(
    d3.rollup(processedVehicleData, v => d3.sum(v, d => d.number), d => d.year.getFullYear()),
    ([year, total]) => ({
      year: new Date(year, 0, 1),
      total: total
    })
  ).sort((a, b) => a.year - b.year);
  
  console.log("Aggregated Vehicle Data:", aggregatedVehicleData);

  // 定义 x 轴时间范围，取 COE 数据与车辆数据聚合的最小与最大日期
  const xMin = d3.min([d3.min(processedCoeData, d => d.date), d3.min(aggregatedVehicleData, d => d.year)]);
  const xMax = d3.max([d3.max(processedCoeData, d => d.date), d3.max(aggregatedVehicleData, d => d.year)]);
  const xScale = d3.scaleTime().domain([xMin, xMax]).range([0, innerWidth]);
  
  // 定义左侧 y 轴（COE Premium）
  const yLeft = d3.scaleLinear()
    .domain([0, d3.max(processedCoeData, d => d.premium)]).nice()
    .range([innerHeight, 0]);
  
  // 定义右侧 y 轴（车辆总数）
  const yRight = d3.scaleLinear()
    .domain([0, d3.max(aggregatedVehicleData, d => d.total)]).nice()
    .range([innerHeight, 0]);

  // 定义坐标轴
  const xAxis = d3.axisBottom(xScale).ticks(8);
  const yAxisLeft = d3.axisLeft(yLeft).ticks(6).tickFormat(d => `$${d3.format(".2s")(d)}`);
  const yAxisRight = d3.axisRight(yRight).ticks(6).tickFormat(d3.format(".2s"));
  
  // 绘制坐标轴
  chart.append("g")
    .attr("class", "x-axis")
    .attr("transform", `translate(0, ${innerHeight})`)
    .call(xAxis);
  
  chart.append("g")
    .attr("class", "y-axis left")
    .call(yAxisLeft)
    .append("text")
    .attr("class", "axis-label")
    .attr("transform", "rotate(-90)")
    .attr("y", -50)
    .attr("x", -innerHeight / 2)
    .attr("fill", "steelblue")
    .text("COE Premium ($)");
  
  chart.append("g")
    .attr("class", "y-axis right")
    .attr("transform", `translate(${innerWidth}, 0)`)
    .call(yAxisRight)
    .append("text")
    .attr("class", "axis-label")
    .attr("transform", "rotate(-90)")
    .attr("y", 60)
    .attr("x", innerHeight / 2)
    .attr("fill", "orange")
    .text("Total Vehicles");
  
  // 添加网格线
  chart.append("g")
    .attr("class", "grid")
    .call(d3.axisLeft(yLeft)
      .ticks(6)
      .tickSize(-innerWidth)
      .tickFormat(""));
  
  // 定义折线生成器
  const coeLine = d3.line()
    .x(d => xScale(d.date))
    .y(d => yLeft(d.premium));
  
  const vehicleLine = d3.line()
    .x(d => xScale(d.year))
    .y(d => yRight(d.total));
  
  // 绘制 COE 折线（全部类别一起展示，可根据需要进一步按类别拆分）
  chart.append("path")
    .datum(processedCoeData)
    .attr("class", "line coe-line")
    .attr("stroke", "#e63946")
    .attr("d", coeLine);
  
  // 绘制车辆聚合折线
  chart.append("path")
    .datum(aggregatedVehicleData)
    .attr("class", "line vehicle-line")
    .attr("stroke", "#2a9d8f")
    .attr("d", vehicleLine);
  
  // 添加垂直注释线，标注 COE 定义变化（2022年5月）
  const changeDate = parseCoeDate("May-22");
  chart.append("line")
    .attr("class", "change-line")
    .attr("x1", xScale(changeDate))
    .attr("x2", xScale(changeDate))
    .attr("y1", 0)
    .attr("y2", innerHeight)
    .attr("stroke", "red")
    .attr("stroke-dasharray", "4,4");
  
  chart.append("text")
    .attr("class", "change-text")
    .attr("x", xScale(changeDate) + 5)
    .attr("y", 20)
    .attr("fill", "red")
    .text("Definition changed in May 2022");
  
  // 添加 tooltip
  const tooltip = d3.select("body").append("div")
    .attr("class", "tooltip")
    .style("opacity", 0);
  
  // 添加 COE 数据点 tooltip
  chart.selectAll(".dot-coe")
    .data(processedCoeData)
    .enter().append("circle")
    .attr("class", "dot-coe")
    .attr("cx", d => xScale(d.date))
    .attr("cy", d => yLeft(d.premium))
    .attr("r", 4)
    .attr("fill", "#e63946")
    .on("mouseover", (event, d) => {
      tooltip.transition().duration(200).style("opacity", 0.9);
      tooltip.html(`Month: ${d3.timeFormat("%b %Y")(d.date)}<br>Category: ${d.vehicle_class}<br>Premium: $${d.premium}`)
        .style("left", `${event.pageX + 15}px`)
        .style("top", `${event.pageY - 28}px`);
    })
    .on("mouseout", () => tooltip.transition().duration(500).style("opacity", 0));
  
  // 添加车辆数据点 tooltip
  chart.selectAll(".dot-vehicle")
    .data(aggregatedVehicleData)
    .enter().append("circle")
    .attr("class", "dot-vehicle")
    .attr("cx", d => xScale(d.year))
    .attr("cy", d => yRight(d.total))
    .attr("r", 4)
    .attr("fill", "#2a9d8f")
    .on("mouseover", (event, d) => {
      tooltip.transition().duration(200).style("opacity", 0.9);
      tooltip.html(`Year: ${d3.timeFormat("%Y")(d.year)}<br>Total Vehicles: ${d.total}`)
        .style("left", `${event.pageX + 15}px`)
        .style("top", `${event.pageY - 28}px`);
    })
    .on("mouseout", () => tooltip.transition().duration(500).style("opacity", 0));
  
}).catch(error => {
  console.error("Error loading CSV data:", error);
});
</script>
</body>
</html>
