<!DOCTYPE html>
<html>
<head>
    <title>Singapore Elderly Population and HDB Prices</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        .container { display: grid; grid-template-rows: auto auto; gap: 20px; padding: 20px; }
        #map-container { height: 700px; border: 1px solid #ddd; position: relative; }
        #chart-container { height: 400px; border: 1px solid #ddd; }
        .tooltip {
            position: absolute;
            padding: 10px;
            background: white;
            border: 1px solid #ccc;
            pointer-events: none;
            font-family: Arial;
        }
        .dropdown { margin: 20px; }
        .legend {
            position: absolute;
            right: 30px;
            top: 30px;
            background: rgba(255,255,255,0.8);
            padding: 10px;
            font-size: 12px;
            border: 1px solid #ccc;
        }
        .legend div {
            display: flex;
            align-items: center;
            margin-bottom: 4px;
        }
        .legend span {
            width: 20px;
            height: 12px;
            margin-right: 6px;
            display: inline-block;
        }
    </style>
</head>
<body>
<div class="container">
    <div id="map-container">
        <div id="legend" class="legend"></div>
    </div>
    <div id="chart-container"></div>
</div>
<div class="dropdown">
    <label for="year-select">Select Year:</label>
    <select id="year-select">
        <option value="2003">2003</option>
        <option value="2008">2008</option>
        <option value="2013">2013</option>
        <option value="2018" selected>2018</option>
    </select>
    <br><br>
    <label for="view-mode">Display Mode:</label>
    <select id="view-mode">
        <option value="elderly">Elderly Proportion</option>
        <option value="price">Average HDB Price</option>
    </select>
    <br><br>
    <label for="indicator-select">Select Indicator:</label>
    <select id="indicator-select">
        <option value="Proportion Of Elderly Residents (65 Years & Over) Among Resident Population">Proportion of Elderly Residents</option>
        <option value="Sex Ratio Of Elderly Residents (65 Years & Over)">Sex Ratio of Elderly Residents</option>
        <option value="Proportion Of Elderly Residents (65 Years & Over) In Labour Force">Elderly Labour Force Participation Rate</option>
    </select>
</div>

<script>
// Load data from GitHub
Promise.all([
  d3.csv("https://raw.githubusercontent.com/carionb/0322/main/elderly.csv", d3.autoType),
  d3.csv("https://raw.githubusercontent.com/carionb/0322/main/KeyIndicatorsOnTheElderlyAnnual.csv", d3.autoType),
  d3.csv("https://raw.githubusercontent.com/carionb/0322/main/PriceRangeofHDBFlatsOffered.csv", d3.autoType),
  d3.json("https://raw.githubusercontent.com/carionb/0322/main/MasterPlan2019PlanningAreaBoundaryNoSea.geojson")
]).then(([elderlyData, indicatorData, priceData, geoData]) => {
  const normalizeName = name => name.trim().toUpperCase().replace(/[^A-Z]/g, "");
  const areaMap = new Map();
  geoData.features.forEach(f => {
    const name = extractPLNAreaName(f.properties.Description);
    if (name) {
      const normalized = normalizeName(name);
      const centroid = d3.geoCentroid(f);
      areaMap.set(normalized, centroid);
    }
  });

  priceData.forEach(d => {
    d.min_selling_price = +d.min_selling_price;
    d.max_selling_price = +d.max_selling_price;
    d.avg_price = (d.min_selling_price + d.max_selling_price) / 2;
  });
  const priceRollup = d3.rollup(
    priceData,
    v => d3.mean(v, d => d.avg_price),
    d => String(d.financial_year),
    d => normalizeName(d["Town/estate"])
  );

  const svg = d3.select("#map-container").append("svg").attr("width", 1000).attr("height", 700);

  function drawCircles(year, mode) {
    const filtered = elderlyData.filter(d => d.SHS_year === +year);
    const validPrices = Array.from(priceRollup.get(String(year))?.values() || []);
    const maxPrice = d3.max(validPrices) || 1;

    svg.selectAll("circle").data(filtered, d => d['Town/estate'])
      .join(
        enter => enter.append("circle")
          .attr("cx", d => {
            const coords = areaMap.get(normalizeName(d['Town/estate']));
            return coords ? d3.geoMercator().center([103.8, 1.35]).scale(45000).translate([500, 350])(coords)[0] : -1000;
          })
          .attr("cy", d => {
            const coords = areaMap.get(normalizeName(d['Town/estate']));
            return coords ? d3.geoMercator().center([103.8, 1.35]).scale(45000).translate([500, 350])(coords)[1] : -1000;
          })
          .attr("r", d => {
            const key = normalizeName(d['Town/estate']);
            if (mode === 'price') {
              const price = priceRollup.get(String(year))?.get(key);
              return price ? Math.sqrt(price) / 500 : 2;
            } else {
              return Math.sqrt(d.Total) / 50;
            }
          })
          .attr("fill", d => {
            const key = normalizeName(d['Town/estate']);
            if (mode === 'price') {
              const price = priceRollup.get(String(year))?.get(key);
              return price ? d3.interpolateBlues(price / maxPrice) : '#ccc';
            } else {
              return d3.interpolateReds(d.Elderly / d.Total);
            }
          })
          .attr("opacity", 0.8),
        update => update.transition().duration(500)
          .attr("r", d => {
            const key = normalizeName(d['Town/estate']);
            if (mode === 'price') {
              const price = priceRollup.get(String(year))?.get(key);
              return price ? Math.sqrt(price) / 500 : 2;
            } else {
              return Math.sqrt(d.Total) / 50;
            }
          })
          .attr("fill", d => {
            const key = normalizeName(d['Town/estate']);
            if (mode === 'price') {
              const price = priceRollup.get(String(year))?.get(key);
              return price ? d3.interpolateBlues(price / maxPrice) : '#ccc';
            } else {
              return d3.interpolateReds(d.Elderly / d.Total);
            }
          }),
        exit => exit.remove()
      );

    updateLegend(mode);
    updateChart(document.getElementById("indicator-select").value, indicatorData);
  }

  updateMap();
  document.getElementById("year-select").addEventListener("change", updateMap);
  document.getElementById("view-mode").addEventListener("change", updateMap);
  document.getElementById("indicator-select").addEventListener("change", () => {
    updateChart(document.getElementById("indicator-select").value, indicatorData);
  });
});

function extractPLNAreaName(description) {
  if (!description) return null;
  const regex = /<th>PLN_AREA_N<\/th>\s*<td>([^<]+)<\/td>/i;
  const match = description.match(regex);
  return match ? match[1].trim() : null;
}

function getIndicatorSeries(indicatorData, selectedIndicator) {
  const row = indicatorData.find(d => d["DataSeries"].trim() === selectedIndicator.trim());
  if (!row) return [];
  return Object.entries(row)
    .filter(([key]) => /^\d{4}$/.test(key))
    .map(([year, value]) => ({ year: +year, value: +value }))
    .filter(d => !isNaN(d.value));
}

function updateChart(selectedIndicator, indicatorData) {
  const data = getIndicatorSeries(indicatorData, selectedIndicator);
  console.log("Parsed indicator data:", data);
}

function updateLegend(mode) {
  const legend = d3.select("#legend");
  legend.selectAll("*").remove();

  const stops = mode === 'price'
    ? ["< $150k", "$200k", "$250k", "$300k", "$350k+"].map((label, i) => ({ color: d3.interpolateBlues(i / 4), label }))
    : ["< 5%", "10%", "15%", "20%", "25%+"].map((label, i) => ({ color: d3.interpolateReds(i / 4), label }));

  legend.selectAll("div")
    .data(stops)
    .enter()
    .append("div")
    .html(d => `<span style="background:${d.color}"></span>${d.label}`);
}

function updateMap() {
  const year = document.getElementById("year-select").value;
  const mode = document.getElementById("view-mode").value;
  drawCircles(year, mode);
  updateLegend(mode);
}
</script>
</body>
</html>
