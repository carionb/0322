<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>COE Prices & Vehicle Population Analysis</title>
  <script src="https://d3js.org/d3.v6.min.js"></script>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 40px;
      background: #f8f9fa;
    }
    .dashboard {
      background: white;
      padding: 30px;
      border-radius: 12px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }
    .controls {
      display: flex;
      gap: 20px;
      margin-bottom: 30px;
    }
    .control-group {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    select {
      padding: 8px 12px;
      border-radius: 6px;
      border: 1px solid #ced4da;
      background: white;
    }
    .axis-label {
      font-size: 14px;
      fill: #6c757d;
    }
    .grid line {
      stroke: #e9ecef;
      stroke-dasharray: 3 3;
    }
    .tooltip {
      position: absolute;
      padding: 12px;
      background: rgba(0,0,0,0.8);
      color: white;
      border-radius: 4px;
      pointer-events: none;
      font-size: 14px;
    }
    .line {
      fill: none;
      stroke-width: 2;
      transition: opacity 0.3s;
    }
  </style>
</head>
<body>
  <div class="dashboard">
    <div class="controls">
      <div class="control-group">
        <label>Vehicle Category:</label>
        <select id="categorySelect"></select>
      </div>
      <div class="control-group">
        <label>Vehicle Type:</label>
        <select id="typeSelect"></select>
      </div>
      <div class="control-group">
        <label>Year Range:</label>
        <select id="yearSelect"></select>
      </div>
    </div>
    <svg width="1000" height="600"></svg>
  </div>

<script>
// 配置参数
const config = {
  width: 1000,
  height: 600,
  margin: {top: 60, right: 100, bottom: 100, left: 80},
  transitionDuration: 500
};

// 初始化SVG
const svg = d3.select("svg")
  .attr("width", config.width)
  .attr("height", config.height);

// 计算绘图区域尺寸
const innerWidth = config.width - config.margin.left - config.margin.right;
const innerHeight = config.height - config.margin.top - config.margin.bottom;

// 创建主绘图区域
const chart = svg.append("g")
  .attr("transform", `translate(${config.margin.left},${config.margin.top})`);

// 定义日期解析函数
const parseCoeDate = d3.timeParse("%b-%y"); // 解析 COE 数据中 Month 字段，如 "Jan-10"
const parseVehicleYear = d3.timeParse("%Y");  // 解析车辆数据中的 year 字段

// 清洗 COE 数据行（去除键和值两侧空格，并处理 Premium 字段）
function cleanRowCoe(row) {
  const newRow = {};
  for (const key in row) {
    newRow[key.trim()] = typeof row[key] === "string" ? row[key].trim() : row[key];
  }
  // 处理 Premium 字段（去除逗号）
  if (newRow.Premium) {
    newRow.Premium = +newRow.Premium.replace(/,/g, "");
  }
  return newRow;
}

// 清洗车辆数据行（去除键和值两侧空格，并处理 number 字段）
function cleanRowVehicle(row) {
  const newRow = {};
  for (const key in row) {
    newRow[key.trim()] = typeof row[key] === "string" ? row[key].trim() : row[key];
  }
  if (newRow.number) {
    newRow.number = +newRow.number.replace(/,/g, "");
  }
  return newRow;
}

// CSV 数据的 URL —— 请确保路径正确
const coeURL = "https://raw.githubusercontent.com/carionb/0322/main/COEBiddingResultsPrices.csv";
const vehicleURL = "https://raw.githubusercontent.com/carionb/0322/main/AnnualMotorVehiclePopulationbyVehicleType.csv";

// 加载数据
Promise.all([
  d3.csv(coeURL, cleanRowCoe),
  d3.csv(vehicleURL, cleanRowVehicle)
]).then(([coeData, vehicleData]) => {
  console.log("First row of COE data:", coeData[0]);
  console.log("First row of Vehicle data:", vehicleData[0]);

  // 处理 COE 数据：解析 Month 字段并转换 Premium
  const processedCoeData = coeData.map(d => ({
    date: parseCoeDate(d.Month),
    category: d["Vehicle Class"],
    premium: d.Premium
  })).filter(d => d.date); // 过滤解析失败的行

  // 提取车辆数据筛选器选项
  const vehicleCategories = [...new Set(vehicleData.map(d => d.Category))];
  const vehicleTypes = [...new Set(vehicleData.map(d => d.Type))];

  // 初始化筛选器
  initFilters(vehicleCategories, vehicleTypes);

  // 初始渲染
  updateVisualization(processedCoeData, vehicleData);

  // 监听筛选器变化
  d3.selectAll("select").on("change", () => {
    updateVisualization(processedCoeData, vehicleData);
  });
}).catch(error => {
  console.error("Error loading CSV data:", error);
});

function initFilters(categories, types) {
  const categorySelect = d3.select("#categorySelect");
  categorySelect.selectAll("option")
    .data(["All", ...categories])
    .join("option")
    .text(d => d);

  const typeSelect = d3.select("#typeSelect");
  typeSelect.selectAll("option")
    .data(["All", ...types])
    .join("option")
    .text(d => d);

  const years = d3.range(2005, 2025);
  const yearSelect = d3.select("#yearSelect");
  yearSelect.selectAll("option")
    .data(["All", ...years])
    .join("option")
    .text(d => d === "All" ? "All Years" : d);
}

function updateVisualization(coeData, vehicleData) {
  // 获取当前筛选条件
  const selectedCategory = d3.select("#categorySelect").property("value");
  const selectedType = d3.select("#typeSelect").property("value");
  const selectedYear = d3.select("#yearSelect").property("value");

  // 筛选车辆数据
  const filteredVehicleData = vehicleData.filter(d => {
    return (selectedCategory === "All" || d.Category === selectedCategory) &&
           (selectedType === "All" || d.Type === selectedType) &&
           (selectedYear === "All" || d.year === selectedYear);
  });

  // 按年份聚合车辆数量
  const vehicleAggregation = d3.rollup(
    filteredVehicleData,
    v => d3.sum(v, d => d.number),
    d => d.year
  );
  const vehicleSeries = Array.from(vehicleAggregation, ([year, total]) => ({
    year: parseVehicleYear(year),
    total
  })).sort((a, b) => a.year - b.year);

  // 定义 x 轴比例尺（COE 数据和车辆数据共同的时间范围）
  const xExtent = d3.extent([...coeData.map(d => d.date), ...vehicleSeries.map(d => d.year)]);
  const xScale = d3.scaleTime().domain(xExtent).range([0, innerWidth]);

  // 定义 y 轴比例尺
  const y1Scale = d3.scaleLinear()
    .domain([0, d3.max(coeData, d => d.premium)])
    .nice()
    .range([innerHeight, 0]);
  const y2Scale = d3.scaleLinear()
    .domain([0, d3.max(vehicleSeries, d => d.total)])
    .nice()
    .range([innerHeight, 0]);

  // 创建坐标轴
  const xAxis = d3.axisBottom(xScale).ticks(8);
  const y1Axis = d3.axisLeft(y1Scale).ticks(6).tickFormat(d => `$${d3.format(".2s")(d)}`);
  const y2Axis = d3.axisRight(y2Scale).ticks(6).tickFormat(d3.format(".2s"));

  // 更新坐标轴
  chart.selectAll(".x-axis").remove();
  chart.append("g")
    .attr("class", "x-axis")
    .attr("transform", `translate(0, ${innerHeight})`)
    .call(xAxis);

  chart.selectAll(".y1-axis").remove();
  chart.append("g")
    .attr("class", "y1-axis")
    .call(y1Axis)
    .append("text")
    .attr("class", "axis-label")
    .attr("transform", "rotate(-90)")
    .attr("y", -50)
    .attr("x", -innerHeight / 2)
    .text("COE Premium ($)");

  chart.selectAll(".y2-axis").remove();
  chart.append("g")
    .attr("class", "y2-axis")
    .attr("transform", `translate(${innerWidth}, 0)`)
    .call(y2Axis)
    .append("text")
    .attr("class", "axis-label")
    .attr("transform", "rotate(-90)")
    .attr("y", 60)
    .attr("x", innerHeight / 2)
    .text("Total Vehicle Count");

  // 添加网格线
  chart.selectAll(".grid").remove();
  chart.append("g")
    .attr("class", "grid")
    .call(d3.axisLeft(y1Scale)
      .ticks(6)
      .tickSize(-innerWidth)
      .tickFormat(""));
  
  // 定义折线生成器
  const coeLine = d3.line()
    .x(d => xScale(d.date))
    .y(d => y1Scale(d.premium));
  
  const vehicleLine = d3.line()
    .x(d => xScale(d.year))
    .y(d => y2Scale(d.total));
  
  // 绘制 COE 折线
  chart.selectAll(".coe-line").remove();
  chart.append("path")
    .datum(coeData)
    .attr("class", "line coe-line")
    .attr("stroke", "#e63946")
    .attr("d", coeLine);
  
  // 绘制车辆聚合折线
  chart.selectAll(".vehicle-line").remove();
  chart.append("path")
    .datum(vehicleSeries)
    .attr("class", "line vehicle-line")
    .attr("stroke", "#2a9d8f")
    .attr("d", vehicleLine);
  
  // 添加垂直注释线：标注 2022年5月（May-22）
  const changeDate = parseCoeDate("May-22");
  chart.selectAll(".change-line").remove();
  chart.append("line")
    .attr("class", "change-line")
    .attr("x1", xScale(changeDate))
    .attr("x2", xScale(changeDate))
    .attr("y1", 0)
    .attr("y2", innerHeight)
    .attr("stroke", "red")
    .attr("stroke-dasharray", "4,4");
  
  chart.selectAll(".change-text").remove();
  chart.append("text")
    .attr("class", "change-text")
    .attr("x", xScale(changeDate) + 5)
    .attr("y", 20)
    .attr("fill", "red")
    .text("Definition changed in May 2022");
  
  // 添加 tooltip（在 body 中创建 div）
  d3.select("body").selectAll(".tooltip").remove();
  const tooltip = d3.select("body").append("div")
    .attr("class", "tooltip")
    .style("opacity", 0);
  
  // COE 数据 tooltip 圆点
  chart.selectAll(".dot-coe").remove();
  chart.selectAll(".dot-coe")
    .data(coeData)
    .enter()
    .append("circle")
    .attr("class", "dot-coe")
    .attr("cx", d => xScale(d.date))
    .attr("cy", d => y1Scale(d.premium))
    .attr("r", 4)
    .attr("fill", "#e63946")
    .on("mouseover", (event, d) => {
      tooltip.transition().duration(200).style("opacity", 0.9);
      tooltip.html(`Month: ${d3.timeFormat("%b %Y")(d.date)}<br>Premium: $${d.premium}`)
        .style("left", `${event.pageX + 15}px`)
        .style("top", `${event.pageY - 28}px`);
    })
    .on("mouseout", () => tooltip.transition().duration(500).style("opacity", 0));
  
  // 车辆数据 tooltip 圆点
  chart.selectAll(".dot-vehicle").remove();
  chart.selectAll(".dot-vehicle")
    .data(vehicleSeries)
    .enter()
    .append("circle")
    .attr("class", "dot-vehicle")
    .attr("cx", d => xScale(d.year))
    .attr("cy", d => y2Scale(d.total))
    .attr("r", 4)
    .attr("fill", "#2a9d8f")
    .on("mouseover", (event, d) => {
      tooltip.transition().duration(200).style("opacity", 0.9);
      tooltip.html(`Year: ${d3.timeFormat("%Y")(d.year)}<br>Total: ${d.total}`)
        .style("left", `${event.pageX + 15}px`)
        .style("top", `${event.pageY - 28}px`);
    })
    .on("mouseout", () => tooltip.transition().duration(500).style("opacity", 0));
  
  // 复选框交互
  d3.select("#toggleCoe").on("change", function() {
    const display = this.checked ? "visible" : "hidden";
    chart.selectAll(".coe-line, .dot-coe").style("visibility", display);
  });
  
  d3.select("#toggleVehicle").on("change", function() {
    const display = this.checked ? "visible" : "hidden";
    chart.selectAll(".vehicle-line, .dot-vehicle").style("visibility", display);
  });
}
</script>
</body>
</html>
