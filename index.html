<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>COE Prices & Vehicle Population Analysis</title>
  <script src="https://d3js.org/d3.v6.min.js"></script>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 40px;
      background: #f8f9fa;
    }
    .dashboard {
      background: white;
      padding: 30px;
      border-radius: 12px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }
    .controls {
      display: flex;
      gap: 20px;
      margin-bottom: 30px;
    }
    .control-group {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    select {
      padding: 8px 12px;
      border-radius: 6px;
      border: 1px solid #ced4da;
      background: white;
    }
    .axis-label {
      font-size: 14px;
      fill: #6c757d;
    }
    .grid line {
      stroke: #e9ecef;
      stroke-dasharray: 3 3;
    }
    .tooltip {
      position: absolute;
      padding: 12px;
      background: rgba(0,0,0,0.8);
      color: white;
      border-radius: 4px;
      pointer-events: none;
      font-size: 14px;
    }
    .line {
      fill: none;
      stroke-width: 2;
      transition: opacity 0.3s;
    }
  </style>
</head>
<body>
  <div class="dashboard">
    <!-- 此示例暂未加入下拉筛选，直接展示整体数据 -->
    <svg width="1000" height="600"></svg>
  </div>

<script>
  // 配置参数
  const config = {
    width: 1000,
    height: 600,
    margin: {top: 60, right: 100, bottom: 100, left: 80},
    transitionDuration: 500
  };

  // 初始化 SVG
  const svg = d3.select("svg")
    .attr("width", config.width)
    .attr("height", config.height);

  // 计算绘图区域尺寸
  const innerWidth = config.width - config.margin.left - config.margin.right;
  const innerHeight = config.height - config.margin.top - config.margin.bottom;

  // 创建主绘图区域
  const chart = svg.append("g")
    .attr("transform", `translate(${config.margin.left},${config.margin.top})`);

  // 定义日期解析函数
  // COE 数据中 Month 字段格式为 "10-Jan"（年份两位在前），使用 "%y-%b"
  const parseCoeDate = d3.timeParse("%y-%b");
  // 车辆数据中 year 字段为 "2005" 等，直接转换
  const parseVehicleYear = d3.timeParse("%Y");

  // 使用 d3.autoType 读取数据时，CSV 字段保持原始名称（区分大小写）
  // COE CSV 示例字段： month, bidding_no, vehicle_class, quota, bids_success, bids_received, premium
  // 车辆 CSV 示例字段： year, category, type, number

  // CSV 文件的 URL —— 请根据实际情况修改为 GitHub raw 链接
  const coeURL = "https://raw.githubusercontent.com/carionb/0322/main/COEBiddingResultsPrices.csv";
  const vehicleURL = "https://raw.githubusercontent.com/carionb/0322/main/AnnualMotorVehiclePopulationbyVehicleType.csv";

  // 加载数据
  Promise.all([
    d3.csv(coeURL, d3.autoType),
    d3.csv(vehicleURL, d3.autoType)
  ]).then(([coeData, vehicleData]) => {
    console.log("First row of COE data:", coeData[0]);
    console.log("First row of Vehicle data:", vehicleData[0]);

    // 处理 COE 数据：解析 "month" 字段，转换 premium 数值（假设已自动转换）
    const processedCoeData = coeData.map(d => ({
      date: parseCoeDate(d.month),  // 使用 d.month（如 "10-Jan"）
      vehicle_class: d.vehicle_class,
      premium: d.premium
    })).filter(d => d.date); // 过滤解析失败的行

    // 处理车辆数据：将 "year" 转为日期对象（代表当年1月1日），直接使用 "number"
    const processedVehicleData = vehicleData.map(d => ({
      year: new Date(d.year, 0, 1),
      category: d.category,
      type: d.type,
      number: d.number
    }));

    // 按年份聚合车辆数据（忽略 category 和 type）
    const aggregatedVehicleData = Array.from(
      d3.rollup(processedVehicleData, v => d3.sum(v, d => d.number), d => d.year.getFullYear()),
      ([year, total]) => ({ year: new Date(year, 0, 1), total })
    ).sort((a, b) => a.year - b.year);

    console.log("Aggregated Vehicle Data:", aggregatedVehicleData);

    // 定义 x 轴比例尺（时间范围取 COE 数据与车辆数据聚合的最小/最大日期）
    const xExtent = d3.extent([...processedCoeData.map(d => d.date), ...aggregatedVehicleData.map(d => d.year)]);
    const xScale = d3.scaleTime().domain(xExtent).range([0, innerWidth]);

    // 定义左侧 y 轴比例尺（COE Premium）
    const yLeft = d3.scaleLinear()
      .domain([0, d3.max(processedCoeData, d => d.premium)]).nice()
      .range([innerHeight, 0]);

    // 定义右侧 y 轴比例尺（车辆总数）
    const yRight = d3.scaleLinear()
      .domain([0, d3.max(aggregatedVehicleData, d => d.total)]).nice()
      .range([innerHeight, 0]);

    // 定义坐标轴
    const xAxis = d3.axisBottom(xScale).ticks(8);
    const yAxisLeft = d3.axisLeft(yLeft).ticks(6).tickFormat(d => `$${d3.format(".2s")(d)}`);
    const yAxisRight = d3.axisRight(yRight).ticks(6).tickFormat(d3.format(".2s"));

    // 绘制坐标轴
    chart.append("g")
      .attr("class", "x-axis")
      .attr("transform", `translate(0, ${innerHeight})`)
      .call(xAxis);

    chart.append("g")
      .attr("class", "y-axis left")
      .call(yAxisLeft)
      .append("text")
      .attr("class", "axis-label")
      .attr("transform", "rotate(-90)")
      .attr("y", -50)
      .attr("x", -innerHeight / 2)
      .attr("fill", "steelblue")
      .text("COE Premium ($)");

    chart.append("g")
      .attr("class", "y-axis right")
      .attr("transform", `translate(${innerWidth}, 0)`)
      .call(yAxisRight)
      .append("text")
      .attr("class", "axis-label")
      .attr("transform", "rotate(-90)")
      .attr("y", 60)
      .attr("x", innerHeight / 2)
      .attr("fill", "orange")
      .text("Total Vehicles");

    // 添加网格线
    chart.append("g")
      .attr("class", "grid")
      .call(d3.axisLeft(yLeft)
        .ticks(6)
        .tickSize(-innerWidth)
        .tickFormat(""));

    // 定义折线生成器
    const coeLine = d3.line()
      .x(d => xScale(d.date))
      .y(d => yLeft(d.premium));

    const vehicleLine = d3.line()
      .x(d => xScale(d.year))
      .y(d => yRight(d.total));

    // 绘制 COE 折线（所有类别数据一起显示）
    chart.append("path")
      .datum(processedCoeData)
      .attr("class", "line coe-line")
      .attr("stroke", "#e63946")
      .attr("d", coeLine);

    // 绘制车辆聚合折线
    chart.append("path")
      .datum(aggregatedVehicleData)
      .attr("class", "line vehicle-line")
      .attr("stroke", "#2a9d8f")
      .attr("d", vehicleLine);

    // 添加垂直注释线，标注 COE 定义变化（2022年5月）
    const changeDate = parseCoeDate("May-22");
    chart.append("line")
      .attr("class", "change-line")
      .attr("x1", xScale(changeDate))
      .attr("x2", xScale(changeDate))
      .attr("y1", 0)
      .attr("y2", innerHeight)
      .attr("stroke", "red")
      .attr("stroke-dasharray", "4,4");

    chart.append("text")
      .attr("class", "change-text")
      .attr("x", xScale(changeDate) + 5)
      .attr("y", 20)
      .attr("fill", "red")
      .text("Definition changed in May 2022");

    // 添加 tooltip
    d3.select("body").selectAll(".tooltip").remove();
    const tooltip = d3.select("body").append("div")
      .attr("class", "tooltip")
      .style("opacity", 0);

    // 添加 COE 数据点 tooltip
    chart.selectAll(".dot-coe").remove();
    chart.selectAll(".dot-coe")
      .data(processedCoeData)
      .enter().append("circle")
      .attr("class", "dot-coe")
      .attr("cx", d => xScale(d.date))
      .attr("cy", d => yLeft(d.premium))
      .attr("r", 4)
      .attr("fill", "#e63946")
      .on("mouseover", (event, d) => {
        tooltip.transition().duration(200).style("opacity", 0.9);
        tooltip.html(`Month: ${d3.timeFormat("%b %Y")(d.date)}<br>Category: ${d.vehicle_class}<br>Premium: $${d.premium}`)
          .style("left", `${event.pageX + 15}px`)
          .style("top", `${event.pageY - 28}px`);
      })
      .on("mouseout", () => tooltip.transition().duration(500).style("opacity", 0));

    // 添加车辆数据点 tooltip
    chart.selectAll(".dot-vehicle").remove();
    chart.selectAll(".dot-vehicle")
      .data(aggregatedVehicleData)
      .enter().append("circle")
      .attr("class", "dot-vehicle")
      .attr("cx", d => xScale(d.year))
      .attr("cy", d => yRight(d.total))
      .attr("r", 4)
      .attr("fill", "#2a9d8f")
      .on("mouseover", (event, d) => {
        tooltip.transition().duration(200).style("opacity", 0.9);
        tooltip.html(`Year: ${d3.timeFormat("%Y")(d.year)}<br>Total Vehicles: ${d.total}`)
          .style("left", `${event.pageX + 15}px`)
          .style("top", `${event.pageY - 28}px`);
      })
      .on("mouseout", () => tooltip.transition().duration(500).style("opacity", 0));
  }).catch(error => {
    console.error("Error loading CSV data:", error);
  });
</script>
</body>
</html>
